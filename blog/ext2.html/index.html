<!DOCTYPE html>
<html lang="zh">
  <head>
    <title>ext2文件系统 - 拾遗笔记</title>
    <meta charset="utf-8" />
    <meta name="author" content="纪秀峰" />
    <meta name="description" content="ext2文件系统" />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="/media/css/main.css" type="text/css">
    <!-- <link rel="stylesheet" href="/media/css/prettify.css" type="text/css"> -->
  </head>
  <body class="container">
<script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- ji -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-6633117582073327"
     data-ad-slot="1629980291"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="/">拾遗笔记</a></h1>
        <p></p>
        <ul>
          <li><a href="/blog/">Blog</a></li>
          <li><a href="/tags/">Tags</a></li>
          <li><a href="/about/">About</a></li>
          <li><a href="http://github.com/jixiuf">GitHub</a></li>
          <li><a href="/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="http://www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="jixiuf.github.io">
        </form>
      </header>
    </div>

<div>
<div class="post">
<h1>ext2文件系统</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org5f15491">链接</a></li>
<li><a href="#org876aa62">ext2</a>
<ul>
<li><a href="#org1ec214f">超级块（Super Block）</a></li>
<li><a href="#org04f977a">块组描述符表（GDT，Group Descriptor Table）</a></li>
<li><a href="#orged02dbb">块位图（Block Bitmap）</a></li>
<li><a href="#org14fb049">inode位图（inode Bitmap）</a></li>
<li><a href="#org4716123">inode表（inode Table）</a></li>
<li><a href="#orgc391507">数据块（Data Block）</a></li>
</ul>
</li>
<li><a href="#org6b45a1d">可用的命令</a></li>
<li><a href="#orgc2777fd">系统函数</a></li>
</ul>
</div>
</div>

<div id="outline-container-org5f15491" class="outline-2">
<h2 id="org5f15491">链接</h2>
<div class="outline-text-2" id="text-org5f15491">
<p>
<a href="http://learn.akae.cn/media/ch29s02.html">http://learn.akae.cn/media/ch29s02.html</a><br />
</p>
</div>
</div>
<div id="outline-container-org876aa62" class="outline-2">
<h2 id="org876aa62">ext2</h2>
<div class="outline-text-2" id="text-org876aa62">

<div id="org54f2391" class="figure">
<p><img src="/assets/blog/ext2.html/ext2.png" alt="ext2.png" /><br />
</p>
</div>

<p>
文件系统中存储的最小单位是块（Block），一个块究竟多大是在格式化时确定的，例如<br />
mke2fs的-b选项可以设定块大小为1024、2048或4096字节,默认是1024byte。<br />
一个分区的开头必须有1k的boot block，这1k是PC标准规定的，任何文件系统不能使用这<br />
块内容,启动块之后才是文件系统。<br />
ext2文件系统将整个分区划成若干个同样大小的块组（Block Group）<br />
</p>
</div>
<div id="outline-container-org1ec214f" class="outline-3">
<h3 id="org1ec214f">超级块（Super Block）</h3>
<div class="outline-text-3" id="text-org1ec214f">
<p>
描述 <i>整个分区</i> 的文件系统信息，例如块大小、文件系统版本号、上次mount的时间等<br />
等。超级块在每个块组的开头都有一份拷贝。(占用一个block块大小).<br />
由于super block很重要 ，在每个 block group都会存一份进行备份.<br />
</p>
</div>
</div>

<div id="outline-container-org04f977a" class="outline-3">
<h3 id="org04f977a">块组描述符表（GDT，Group Descriptor Table）</h3>
<div class="outline-text-3" id="text-org04f977a">
<p>
由很多块组描述符组成，整个分区分成多少个块组就对应有多少个块组描述符。每个<br />
块组描述符（Group Descriptor）存储一个块组的描述信息，例如在这个块组中从哪<br />
里开始是inode表，从哪里开始是数据块，空闲的inode和数据块还有多少个等等。和<br />
超级块类似，块组描述符表在每个块组的开头也都有一份拷贝_，这些信息是非常重要<br />
的，一旦超级块意外损坏就会丢失整个分区的数据，一旦块组描述符意外损坏就会丢<br />
失整个块组的数据，因此它们都有多份拷贝。/通常内核只用到第0个块组中的拷贝/，当<br />
执行e2fsck检查文件系统一致性时，第0个块组中的超级块和块组描述符表就会拷贝到<br />
其它块组，这样当第0个块组的开头意外损坏时就可以用其它拷贝来恢复，从而减少损<br />
失。<br />
</p>
</div>
</div>
<div id="outline-container-orged02dbb" class="outline-3">
<h3 id="orged02dbb">块位图（Block Bitmap）</h3>
<div class="outline-text-3" id="text-orged02dbb">
<p>
一个块组中的块是这样利用的：数据块存储所有文件的数据，比如某个分区的块大小<br />
是1024字节，某个文件是2049字节，那么就需要三个数据块来存，即使第三个块只存<br />
了一个字节也需要占用一个整块；超级块、块组描述符表、块位图、inode位图、<br />
inode表这几部分存储该块组的描述信息。那么如何知道哪些块已经用来存储文件数据<br />
或其它描述信息，哪些块仍然空闲可用呢？块位图就是用来描述整个块组中哪些块已<br />
用哪些块空闲的，它本身占一个块，其中的每个bit代表本块组中的一个块，这个bit<br />
为1表示该块已用，这个bit为0表示该块空闲可用。<br />
为什么用df命令统计整个磁盘的已用空间非常快呢？因为只需要查看每个块组的块位<br />
图即可，而不需要搜遍整个分区。相反，用du命令查看一个较大目录的已用空间就非<br />
常慢，因为不可避免地要搜遍整个目录的所有文件。<br />
与此相联系的另一个问题是：在格式化一个分区时究竟会划出多少个块组呢？主要的<br />
限制在于块位图本身必须只占一个块。用mke2fs格式化时默认块大小是1024字节，可<br />
以用-b参数指定块大小，现在设块大小指定为b字节，那么一个块可以有8b个bit，这<br />
样大小的一个块位图就可以表示8b个块的占用情况，因此一个块组最多可以有8b个块，<br />
如果整个分区有s个块，那么就可以有s/(8b)个块组。格式化时可以用-g参数指定一个<br />
块组有多少个块，但是通常不需要手动指定，mke2fs工具会计算出最优的数值。<br />
</p>
</div>
</div>

<div id="outline-container-org14fb049" class="outline-3">
<h3 id="org14fb049">inode位图（inode Bitmap）</h3>
<div class="outline-text-3" id="text-org14fb049">
<p>
和块位图类似，本身占一个块，其中每个bit表示一个inode是否空闲可用。<br />
</p>
</div>
</div>
<div id="outline-container-org4716123" class="outline-3">
<h3 id="org4716123">inode表（inode Table）</h3>
<div class="outline-text-3" id="text-org4716123">
<p>
我们知道，一个文件除了数据需要存储之外，一些描述信息也需要存储，例如文件类<br />
型（常规、目录、符号链接等），权限，文件大小，创建/修改/访问时间等，也就是<br />
ls -l命令看到的那些信息，这些信息存在inode中而不是数据块中。每个文件都有一<br />
个inode，一个块组中的所有inode组成了inode表。<br />
<img src="/assets/blog/ext2.html/fs.rootinode.png" alt="fs.rootinode.png" /><br />
</p>

<p>
inode表占多少个块在格式化时就要决定并写入块组描述符中，mke2fs格式化工具的默认策<br />
略是一个块组有多少个8KB就分配多少个inode。由于数据块占了整个块组的绝大部分，也<br />
可以近似认为数据块有多少个8KB就分配多少个inode，换句话说，如果平均每个文件的大<br />
小是8KB，当分区存满的时候inode表会得到比较充分的利用，数据块也不浪费。如果这个<br />
分区存的都是很大的文件（比如电影），则数据块用完的时候inode会有一些浪费，如果这<br />
个分区存的都是很小的文件（比如源代码），则有可能数据块还没用完inode就已经用完了，<br />
数据块可能有很大的浪费。如果用户在格式化时能够对这个分区以后要存储的文件大小做<br />
一个预测，也可以用mke2fs的-i参数手动指定每多少个字节分配一个inode。<br />
</p>
</div>
</div>

<div id="outline-container-orgc391507" class="outline-3">
<h3 id="orgc391507">数据块（Data Block）</h3>
<div class="outline-text-3" id="text-orgc391507">
<p>
根据不同的文件类型有以下几种情况<br />
</p>
<ul class="org-ul">
<li>对于常规文件，文件的数据存储在数据块中。<br /></li>
<li>对于目录，该目录下的所有文件名和目录名存储在数据块中，注意文件名保存<br />
在它所在目录的数据块中，除文件名之外，ls -l命令看到的其它信息都保存在<br />
该文件的inode中。注意这个概念：目录也是一种文件，是一种特殊类型的文件。<br /></li>
<li>对于符号链接，如果目标路径名较短则直接保存在inode中以便更快地查找，如<br />
果目标路径名较长则分配一个数据块来保存。<br /></li>
<li>设备文件、FIFO和socket等特殊文件没有数据块，设备文件的主设备号和次设<br />
备号保存在inode中<br /></li>
</ul>
<p>
默认的块大小是4k.<br />
</p>

<div class="org-src-container">
<pre class="src src-sh">dd <span style="color: #40E0D0;">if</span>=/dev/zero <span style="color: #40E0D0;">of</span>=fs <span style="color: #40E0D0;">count</span>=256 <span style="color: #40E0D0;">bs</span>=4K
mke2fs fs
</pre>
</div>
<p>
块大小是1024字节，1MB的分区共有1024个块，第0个块是启动块，启动块之后才算ext2文<br />
件系统的开始，因此Group 0占据第1个到第1023个块，共1023个块。块位图占一个块，共<br />
有1024×8=8192个bit，足够表示这1023个块了，因此只要一个块组就够了。默认是每8KB<br />
分配一个inode，因此1MB的分区对应128个inode，这些数据都和dumpe2fs的输出吻合。<br />
</p>



<p>
从000000开始的1KB是启动块，由于这不是一个真正的磁盘分区，启动块的内容全部为<br />
零。从000400到0007ff的1KB是超级块，对照着dumpe2fs的输出信息，详细分析如下：<br />
<img src="/assets/blog/ext2.html/fs.sb.png" alt="fs.sb.png" /><br />
</p>

<p>
从000800开始是块组描述符表，这个文件系统较小，只有一个块组描述符，对照着<br />
dumpe2fs的输出信息分析如下：<br />
<img src="/assets/blog/ext2.html/fs.gd.png" alt="fs.gd.png" /><br />
</p>
<div class="org-src-container">
<pre class="src src-sh">dumpe2fs /dev/vg1/portage
dumpe2fs /tmp/fs
</pre>
</div>
<blockquote>
<p>
Group 0: (Blocks 1-1023)<br />
Primary superblock at 1, Group descriptors at 2-2<br />
Reserved GDT blocks at 3-5<br />
Block bitmap at 6 (+5), Inode bitmap at 7 (+6)<br />
Inode table at 8-23 (+7)<br />
986 free blocks, 117 free inodes, 2 directories<br />
Free blocks: 38-1023<br />
Free inodes: 12-128<br />
</p>
</blockquote>
<p>
jkk块组描述符指出，空闲的inode有117个，由于文件系统是新创建的，空闲的inode也是<br />
连续的，inode编号从1到128，空闲的inode编号从12到128。从inode位图可以看出，前<br />
11位都是1，表示前11个inode已用<br />
001c00这一行的128位就表示了所有inode，因此下面的行不管是0还是1都没有意义。已<br />
用的11个inode中，前10个inode是被ext2文件系统保留的，其中第2个inode是根目录，<br />
第11个inode是lost+found目录，块组描述符也指出该组有两个目录，就是根目录和<br />
lost+found。<br />
</p>

<p>
整个文件系统是1MB，每个块是1KB，应该有1024个块，除去启动块还有1023个块，分别编<br />
号为1-1023，它们全都属于Group 0。其中，Block 1是超级块，接下来的块组描述符指出，<br />
块位图是Block 6，因此中间的Block 2-5是块组描述符表，其中Block 3-5保留未用。块<br />
组描述符还指出，inode位图是Block 7，inode表是从Block 8开始的，那么inode表到哪<br />
个块结束呢？由于超级块中指出每个块组有128个inode，每个inode的大小是128字节，因<br />
此共占16个块，inode表的范围是Block 8-23,<br />
<img src="/assets/blog/ext2.html/fs.datablock.png" alt="fs.datablock.png" /><br />
所以数据块从第24block开始 24*1024 =0x6000<br />
</p>

<p>
数据块里的记录是不定长的，<br />
结构是<br />
</p>
<blockquote>
<p>
inode号（4bytes）|记录长度   (2bytes)|filename length(1byte)|filetype(1byte)|filename(不定长)|<br />
</p>
</blockquote>
<p>
上图中分别显示 了 . .. lost+found<br />
</p>
<blockquote>
<p>
00006000: 0200 0000 0c00 0102 2e00 0000 0200 0000  &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.<br />
00006010: 0c00 0202 2e2e 0000 0b00 0000 1400 0a02  &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.<br />
00006020: 6c6f 7374 2b66 6f75 6e64 0000 0c00 0000  lost+found&#x2026;&#x2026;<br />
00006030: 1000 0501 6865 6c6c 6f00 0000 0d00 0000  &#x2026;.hello&#x2026;&#x2026;.<br />
</p>
</blockquote>
<p>
以上内容分别是<br />
</p>
<blockquote>
<p>
0200 0000 对应的inode号是0x00000002 ,<br />
0c00 此条记录共长 12 (0x000c=12),<br />
01 filename名长度是1,<br />
02 filetype 是2,表示目录<br />
2e00 0000   0x00000023 是 "." ,即/目录下的"."<br />
这几个字节数数正好是12bytes<br />
</p>
</blockquote>
<p>
接下的来描述的是 ".."<br />
</p>
<blockquote>
<p>
0200 0000<br />
0c00 0202 2e2e 0000<br />
</p>
</blockquote>
<p>
接下来的描述的是"lost+found"<br />
</p>
<blockquote>
<p>
0b00 0000 1400 0a02<br />
6c6f 7374 2b66 6f75 6e64 0000<br />
对应0b00 0000 ,0x0000000b号inode,即第11个inode<br />
1400 ，0x0014表示，此程记录共占用20byte,<br />
0a 文件长度是10,<br />
02 文件类型是目录<br />
6c6f 7374 2b66 6f75 6e64 是lost+found几个字,<br />
你可以把“lost+found”写到一个文件中，用十六进制编辑器查看<br />
,最后那4个0不太理解。<br />
</p>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-org6b45a1d" class="outline-2">
<h2 id="org6b45a1d">可用的命令</h2>
<div class="outline-text-2" id="text-org6b45a1d">
<p>
dumpe2fs<br />
</p>
</div>
</div>

<div id="outline-container-orgc2777fd" class="outline-2">
<h2 id="orgc2777fd">系统函数</h2>
<div class="outline-text-2" id="text-orgc2777fd">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;stdio.h&gt;</span>
<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;dirent.h&gt;</span>
<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;string.h&gt;</span>
<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;stdlib.h&gt;</span>

<span style="color: #AEAEAE;">/* </span><span style="color: #AEAEAE;">struct dirent {</span><span style="color: #AEAEAE;"> */</span>
<span style="color: #AEAEAE;">/*  </span><span style="color: #AEAEAE;">ino_t          d_ino;       /\* inode number *\/</span><span style="color: #AEAEAE;"> */</span>
<span style="color: #AEAEAE;">/*  </span><span style="color: #AEAEAE;">off_t          d_off;       /\* offset to the next dirent *\/</span><span style="color: #AEAEAE;"> */</span>
<span style="color: #AEAEAE;">/*  </span><span style="color: #AEAEAE;">unsigned short d_reclen;    /\* length of this record *\/</span><span style="color: #AEAEAE;"> */</span>
<span style="color: #AEAEAE;">/*  </span><span style="color: #AEAEAE;">unsigned char  d_type;      /\* type of file *\/</span><span style="color: #AEAEAE;"> */</span>
<span style="color: #AEAEAE;">/*  </span><span style="color: #AEAEAE;">char           d_name[256]; /\* filename *\/</span><span style="color: #AEAEAE;"> */</span>
<span style="color: #AEAEAE;">/* </span><span style="color: #AEAEAE;">};</span><span style="color: #AEAEAE;"> */</span>

<span style="color: #8DA6CE;">int</span> <span style="color: #FF6400;">main</span>(<span style="color: #8DA6CE;">int</span> <span style="color: #40E0D0;">argc</span>, <span style="color: #8DA6CE;">char</span> *<span style="color: #40E0D0;">argv</span>[])
{
  <span style="color: #FBDE2D;">struct</span> <span style="color: #8DA6CE;">dirent</span> *<span style="color: #40E0D0;">dp</span>;
  <span style="color: #8DA6CE;">DIR</span> *<span style="color: #40E0D0;">dfd</span>;
  <span style="color: #FBDE2D;">if</span>((dfd= opendir(<span style="color: #ffa07a;">"/tmp/d/"</span>))==<span style="color: #D8FA3C;">NULL</span>){
    fprintf(stderr,<span style="color: #ffa07a;">"opendir error"</span>);
    exit(1);
  }
  <span style="color: #FBDE2D;">while</span>( (dp = readdir(dfd))!=<span style="color: #D8FA3C;">NULL</span>){
    fprintf(stdout,<span style="color: #ffa07a;">"%s\n"</span>,dp-&gt;d_name);
  }
  closedir(dfd);
  <span style="color: #FBDE2D;">return</span> 0;
}
</pre>
</div>
</div>
</div>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2012-05-01</span>
        <span title="last modification date" class="post-info">2021-09-10</span>
        <span title="tags" class="post-info"><a href="/tags/linux/">Linux</a>, <a href="/tags/c/">C</a></span>
        <span title="author" class="post-info">纪秀峰</span>
      </div>
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          //var disqus_developer = 1;
          var disqus_identifier = "/blog/ext2.html";
          var disqus_url = "http://jixiuf.github.io/blog/ext2.html";
          var disqus_shortname = 'jixiuf';
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <div class="ds-thread"></div>
        <script type="text/javascript">
          var duoshuoQuery = {short_name:'jixiuf'};
          (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = 'http://static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
          || document.getElementsByTagName('body')[0]).appendChild(ds);
          })();
        </script>
      </section>
      <script src="http://code.jquery.com/jquery-latest.min.js"></script>
      <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script> -->
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="/media/js/main.js"></script>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x (<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
          Copyright &copy; 2012 - <span id="footerYear"></span> <a href="mailto:jixiuf &lt;at&gt; gmail &lt;dot&gt; com">纪秀峰</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

  </body>
</html>
