<!DOCTYPE html>
<html lang="zh">
  <head>
    <title>mysql_config.org - 拾遗笔记</title>
    <meta charset="utf-8" />
    <meta name="author" content="纪秀峰" />
    <meta name="description" content="mysql_config.org" />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="/media/css/main.css" type="text/css">
    <!-- <link rel="stylesheet" href="/media/css/prettify.css" type="text/css"> -->
  </head>
  <body class="container">
<script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- ji -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-6633117582073327"
     data-ad-slot="1629980291"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="/">拾遗笔记</a></h1>
        <p></p>
        <ul>
          <li><a href="/blog/">Blog</a></li>
          <li><a href="/tags/">Tags</a></li>
          <li><a href="/about/">About</a></li>
          <li><a href="http://github.com/jixiuf">GitHub</a></li>
          <li><a href="/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="http://www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="jixiuf.github.io">
        </form>
      </header>
    </div>

<div>
<div class="post">
<h1>mysql_config.org</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgc7b41c1">server 层参数</a>
<ul>
<li><a href="#org2d6bc81">复制参数 master (server层做)</a></li>
<li><a href="#org8121731">复制参数 slave (server层做)</a></li>
</ul>
</li>
<li><a href="#orgb21e424">Engine 层参数</a>
<ul>
<li><a href="#org9798e47">innodb</a></li>
</ul>
</li>
<li><a href="#orgc64fdd3">example  with 4G Mem</a></li>
<li><a href="#orgd3345ab">tips</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgc7b41c1" class="outline-2">
<h2 id="orgc7b41c1">server 层参数</h2>
<div class="outline-text-2" id="text-orgc7b41c1">
<ol class="org-ol">
<li><p>
tmp-table-size<br />
default 32M<br />
</p>

<p>
copy to tmp talbe 语句产生的原因是查询需要Order By 或者Group By等<br />
需要用到结果集时，参数中设置的临时表的大小小于结果集的大小时，就<br />
会将该表放在磁盘上，这个时候在硬盘上的IO要比内销差很多。所耗费的<br />
时间也多很多。另外Mysql的另外一个参数max_heap_table_size比<br />
tmp_table_size小时，则系统会把max_heap_table_size的值作为最大的内<br />
存临时表的上限，大于这个时，改写硬盘。<br />
</p></li>
</ol>


<p>
This variable determines the maximum size for a temporary table<br />
in memory. If the table becomes too large, a MYISAM table is<br />
created on disk. Try to avoid temporary tables by optimizing the<br />
queries where possible, but where this is not possible, try to<br />
ensure temporary tables are always stored in memory. Watching the<br />
processlist for queries with temporary tables that take too long<br />
to resolve can give you an early warning that tmp_table_size<br />
needs to be upped. Be aware that memory is also allocated<br />
per-thread. An example where upping this worked for more was a<br />
server where I upped this from 32MB (the default) to 64MB with<br />
immediate effect. The quicker resolution of queries resulted in<br />
less threads being active at any one time, with all-round<br />
benefits for the server, and available memory.<br />
</p>
<ol class="org-ol">
<li>query-cache-type (0|1|2)<br /></li>
<li>query-cache-size<br /></li>
<li>max-connections<br /></li>
<li>table-open-cache<br />
保持处于open 状态的table 的数量（应该是）（需要根据库里表的数量来决定）<br />
mysql 会缓存 一部分 open table, 当缓存满时  再去open 一个table 时， mysql<br />
会根据LRU法则把最旧的table 关闭掉。所以 如果这个值设置的过小的话，<br />
mysql 会频繁的open close table<br />
可以根据Table_open_cache_misses这个值来判断 table-open-cache 是否正常<br />
如果Table_open_cache_misses 远大于Open_tables<br />
这几个变量show  global  status like 'Open%';<br /></li>
<li>wait_timeout (8h? 8day?)<br /></li>
<li>transaction-isolation (rc|rc) 事务隔离级别<br /></li>
<li>key_buffer<br /></li>
<li>low_case_table_names (ignore case )<br /></li>
<li>sort_buffer_size  (order by 是在server 层做)<br /></li>
</ol>
</div>
<div id="outline-container-org2d6bc81" class="outline-3">
<h3 id="org2d6bc81">复制参数 master (server层做)</h3>
<div class="outline-text-3" id="text-org2d6bc81">
<p>
log-bin<br />
server-id<br />
binlog-do-db (哪些库  主从复制)<br />
binlog-ignore-db （忽略哪些库）<br />
binlog-format(row|stmt|mixed) row-整行数据记录  ， stmt-记录sql语句<br />
</p>
</div>
<ul class="org-ul">
<li><a id="org6d4a47a"></a>半同步复制(plugin 存在)<br />
<div class="outline-text-4" id="text-org6d4a47a">
<p>
半同步复制&#x2014; 扔给从库  从库接收后立刻回复master好了，<br />
同步复制&#x2014;  扔给从库  从库接收后，从库上apply后 再回复我好了<br />
</p>

<p>
rpl_semi_sync_master_enabled<br />
rpl_semi_sync_master_timeout<br />
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-org8121731" class="outline-3">
<h3 id="org8121731">复制参数 slave (server层做)</h3>
<div class="outline-text-3" id="text-org8121731">
<ol class="org-ol">
<li>server-id<br /></li>
<li>master-port<br /></li>
<li>slave-skip-errors<br /></li>
<li>relay_log<br /></li>
<li>sync_binlog<br /></li>
<li>replicate-ignore-db replicate-do-db replicate-do-table 与master<br />
上的binlog-do-db inlog-ignore-db 对应<br /></li>
</ol>
</div>
</div>
</div>
<div id="outline-container-orgb21e424" class="outline-2">
<h2 id="orgb21e424">Engine 层参数</h2>
<div class="outline-text-2" id="text-orgb21e424">
</div>
<div id="outline-container-org9798e47" class="outline-3">
<h3 id="org9798e47">innodb</h3>
<div class="outline-text-3" id="text-org9798e47">
<ol class="org-ol">
<li>innodb-buffer-pool-size  default 8M  (一定要调大 50%~-80% mem)<br /></li>
<li><p>
innodb-flush-log-at-tx-commit (0|1|2)<br />
不同的值 影响两个操作 （write,flush） ,<br />
</p>
<ul class="org-ul">
<li>write 是操作系统级的write(意思是说 write 到操作系统的缓存了)<br /></li>
<li>flush  刷日志到硬盘<br /></li>
</ul>
<p>
0  表示每秒钟write and flush 一次，  但是sql commit 的时候并不提交<br />
1  每次sql commit 都会write and flush （最安全 也是最慢的）<br />
2  每次sql commit 都会write  ,但是每间隔1s 才flush 一次 (折中，如果mysql 崩掉 只会丢失1s的数据)<br />
0, the log buffer is written out to the log file once per second<br />
and the flush to disk operation is performed on the log file, but<br />
nothing is done at a transaction commit. When the value is 1 (the<br />
default), the log buffer is written out to the log file at each<br />
transaction commit and the flush to disk operation is performed<br />
on the log file. When the value is 2, the log buffer is written<br />
out to the file at each commit, but the flush to disk operation<br />
is not performed on it. However, the flushing on the log file<br />
takes place once per second also when the value is 2. Note that<br />
the once-per-second flushing is not 100% guaranteed to happen<br />
every second, due to process scheduling issues.<br />
</p></li>

<li>innodb-flush-method(fdatasync|O_DIRECT|O_DSYNC)<br />
基本O_DIRECT<br />
fdatasync  用fsync  告诉操作系统 ( 一定要绕过缓存)<br />
O_DIRECT  redo log 直接到硬盘<br /></li>
<li>innodb-file-per-table 一定要设<br />
每建个表  innodb 为其建两文件<br />
inodb_file_format 与之相关<br /></li>
<li>innodb-log-buffer-size &#x2013;64M<br /></li>
<li>innodb-log-file-size 两个文件轮换着写<br /></li>
<li>innodb-io-capacity=200|2000|20000<br />
200 15000转sasi盘<br />
2000 150000转  做了raid10的盘20块<br />
根据iops来设置<br /></li>
<li>inodb-read-io-threads  2*cpu<br />
inodb-write-io-threads  2*cpu<br /></li>
<li>innodb_stats_on_metadata=off<br /></li>
<li>innodb-buffer-pool-instance=4 左右<br />
innodb-buffer-pool-instance*innodb-buffer-pool-size<br />
实际使用的内存<br /></li>
<li>libaio<br />
innodb_use_native_aio (需要装libaio)<br /></li>
<li>use-sys-malloc (do not use)<br />
use google tc-malloc<br /></li>

<li>mysql 改io 调度器为deadline<br /></li>

<li>sync_binlog：默认情况下，0,表示写日志文件不会马上同步到磁盘。可以设置每N次写操作后同步到磁盘。<br /></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orgc64fdd3" class="outline-2">
<h2 id="orgc64fdd3">example  with 4G Mem</h2>
<div class="outline-text-2" id="text-orgc64fdd3">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">Generated by Percona Configuration Wizard (http://tools.percona.com/) version REL5-20120208</span>
<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">Configuration name server generated for 653252292@qq.com at 2015-07-01 11:34:37</span>

[mysql]

<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">CLIENT #</span>
port                           = 3306
socket                         = /data/mysql/mysql.sock

[mysqld]

<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">GENERAL #</span>
user                           = mysql
default-storage-engine         = InnoDB
socket                         = /data/mysql/mysql.sock
pid-file                       = /data/mysql/mysql.pid

<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">MyISAM #</span>
key-buffer-size                = 32M
myisam-recover                 = FORCE,BACKUP

<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">SAFETY #</span>
max-allowed-packet             = 16M
max-connect-errors             = 1000000
innodb                         = FORCE

<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">DATA STORAGE #</span>
datadir                        = /data/mysql/

<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">BINARY LOGGING #</span>
log-bin                        = /data/mysql/mysql-bin
server_id              = 1
sync-binlog                    = 1
expire_logs_days               = 7
<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">CACHES AND LIMITS #</span>
tmp-table-size                 = 200M
max-heap-table-size            = 200M
sort-buffer-size               =200M
query-cache-type               = 0
query-cache-size               = 0
max-connections                = 500
open-files-limit               = 65535
table-definition-cache         = 1024
table-open-cache               = 2048

<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">INNODB #</span>
innodb-flush-method            = O_DIRECT
innodb-log-files-in-group      = 3
innodb-log-file-size           = 1300M
innodb-flush-log-at-trx-commit = 1
innodb-file-per-table          = 1
innodb-buffer-pool-size        = 2800M
<span style="color: #40E0D0;">explicit_defaults_for_timestamp</span>=true

<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">LOGGING #</span>
log-error                      = /data/mysql/mysql-error.log
log-queries-not-using-indexes  = 0
slow-query-log                 = 1
slow-query-log-file            = /data/mysql/mysql-slow.log
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd3345ab" class="outline-2">
<h2 id="orgd3345ab">tips</h2>
<div class="outline-text-2" id="text-orgd3345ab">
<p>
可以查看 当前mysql 正在执行哪些sql 语句，<br />
可以用来统计 正在大量执行哪些sql 语句<br />
     set global general_log=on<br />
</p>
</div>
</div>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2015-02-06</span>
        <span title="last modification date" class="post-info">2021-09-10</span>
        <span title="tags" class="post-info"><a href="/tags/mysql/">Mysql</a></span>
        <span title="author" class="post-info">纪秀峰</span>
      </div>
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          //var disqus_developer = 1;
          var disqus_identifier = "/blog/mysql_config.html";
          var disqus_url = "http://jixiuf.github.io/blog/mysql_config.html";
          var disqus_shortname = 'jixiuf';
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <div class="ds-thread"></div>
        <script type="text/javascript">
          var duoshuoQuery = {short_name:'jixiuf'};
          (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = 'http://static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
          || document.getElementsByTagName('body')[0]).appendChild(ds);
          })();
        </script>
      </section>
      <script src="http://code.jquery.com/jquery-latest.min.js"></script>
      <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script> -->
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="/media/js/main.js"></script>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x (<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
          Copyright &copy; 2012 - <span id="footerYear"></span> <a href="mailto:jixiuf &lt;at&gt; gmail &lt;dot&gt; com">纪秀峰</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

  </body>
</html>
