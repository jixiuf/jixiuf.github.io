<!DOCTYPE html>
<html lang="zh">
  <head>
    <title>mysql5.6 主从复制的配置过程 - 拾遗笔记</title>
    <meta charset="utf-8" />
    <meta name="author" content="纪秀峰" />
    <meta name="description" content="mysql 主从复制的配置过程" />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="/media/css/main.css" type="text/css">
    <!-- <link rel="stylesheet" href="/media/css/prettify.css" type="text/css"> -->
  </head>
  <body class="container">
<script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- ji -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-6633117582073327"
     data-ad-slot="1629980291"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="/">拾遗笔记</a></h1>
        <p></p>
        <ul>
          <li><a href="/blog/">Blog</a></li>
          <li><a href="/tags/">Tags</a></li>
          <li><a href="/about/">About</a></li>
          <li><a href="http://github.com/jixiuf">GitHub</a></li>
          <li><a href="/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="http://www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="jixiuf.github.io">
        </form>
      </header>
    </div>

<div>
<div class="post">
<h1>mysql5.6 主从复制的配置过程</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org3ef5d86">master 的配置 ip 192.168.1.132</a></li>
<li><a href="#org4fe7191">slave 配置 ip 192.168.1.137</a></li>
<li><a href="#orgd862b19">配置完 之后</a>
<ul>
<li><a href="#org9be00c4">master 上的操作</a></li>
<li><a href="#org1107f5f">slave 上的操作</a></li>
<li><a href="#orgcc6f488">当出现主从不一致的时候的做法，</a></li>
</ul>
</li>
<li><a href="#orgba920ac">mysql热备做DR</a>
<ul>
<li><a href="#org4265170">在master db上使用mysqldump构建基于时间点的一致性全备</a></li>
<li><a href="#org539c150">scp该sql文件到slave dr上面</a></li>
<li><a href="#org263caba">在slave dr上把全备的数据入库</a></li>
<li><a href="#orgf9466c8">在master db上执行授权语句</a></li>
<li><a href="#orgeb9593f">在slave dr上设置热备关系</a></li>
<li><a href="#orgff3b962">注：其中pos和file参数可以从mysqldump出来的sql文件前25行了解到</a></li>
<li><a href="#org18fce64">使用show slave status\G 查看slave的情况</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org3ef5d86" class="outline-2">
<h2 id="org3ef5d86">master 的配置 ip 192.168.1.132</h2>
<div class="outline-text-2" id="text-org3ef5d86">
<p>
[mysqld]<br />
server-id = 1  #这里的数字不能和从库一样<br />
#需要复制的数据库，多个数据库写多行,不写的话默认复制所有库<br />
binlog_do_db = t1<br />
binlog_do_db =t2<br />
</p>

<p>
log-bin                        = /data/mysql/data/mysql-bin<br />
#expire-logs-days               = 14<br />
#sync-binlog                    = 1 #事务提交后立即写入二进制日志，而不是放内存中，避免主服务器故障时事务没有写入日志<br />
binlog_format=MIXED   #混合格式<br />
</p>
</div>
</div>
<div id="outline-container-org4fe7191" class="outline-2">
<h2 id="org4fe7191">slave 配置 ip 192.168.1.137</h2>
<div class="outline-text-2" id="text-org4fe7191">
<p>
[mysqld]<br />
server-id = 2<br />
replicate-do-db =t1<br />
replicate-do-db =t2<br />
binlog-format                  = mixed<br />
replicate-ignore-db=mysql<br />
log-slave-update=true<br />
slave-skip-errors=true<br />
</p>
</div>
</div>

<div id="outline-container-orgd862b19" class="outline-2">
<h2 id="orgd862b19">配置完 之后</h2>
<div class="outline-text-2" id="text-orgd862b19">
</div>
<div id="outline-container-org9be00c4" class="outline-3">
<h3 id="org9be00c4">master 上的操作</h3>
<div class="outline-text-3" id="text-org9be00c4">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #AEAEAE;">#</span><span style="color: #AEAEAE;">master &#19978;&#21019;&#24314;&#29992;&#20110;&#21516;&#27493;&#25968;&#25454;&#30340;&#36134;&#25143;</span>
grant replication slave on *.* to slave@<span style="color: #ffa07a;">'192.168.1.137'</span> identified by <span style="color: #ffa07a;">'slave'</span>;
<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">&#38145;&#34920;</span>
flush tables with read lock;
show master status;
</pre>
</div>
<blockquote>
<p>
mysql&gt;  show master status;<br />
</p>
<!-- This HTML table template is generated by emacs 27.2 -->
<table border="1">
  <tr>
    <td align="left" valign="top">
      &nbsp;File&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Position&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Binlog_Do_DB&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Binlog_Ignore_DB&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Executed_Gtid_Set&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;mysql-bin.000005&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2147&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;t1,t2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
</table>
<p>
mysql-bin.000005   和     2147  这两个数据 会在从库上用到<br />
</p>
</blockquote>
<div class="org-src-container">
<pre class="src src-sh"> <span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">&#23558; t1,t2 &#24211;&#30340;&#25968;&#25454;&#23548;&#20986;&#21040;sql &#25991;&#20214; &#65292;&#28982;&#21518;&#22312;&#20174;&#24211;192.168.1.137 &#19978; &#24314;&#31435;t1,t2 &#24211;&#65292; &#25226;&#25968;&#25454;&#20998;&#21035;&#23548;&#20837;</span>
/usr/bin/mysqldump t1 -uroot -padmin &gt;t1.sql
/usr/bin/mysqldump t2 -uroot -padmin &gt;t2.sql
 <span style="color: #AEAEAE;">#</span><span style="color: #AEAEAE;">&#25110;&#32773; &#20174;&#24211;&#19978;&#21152;&#31435;&#31354;&#24211;t1,t2&#21518;&#65292; &#30452;&#25509;&#36825;&#26679;&#23558;&#20027;&#24211;&#25968;&#25454;&#23548;&#20837;&#21040;&#20174;&#24211;&#20013;</span>
<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">/usr/bin/mysqldump t1 -uroot -padmin --opt | mysql t1 -uroot -padmin -h 192.168.1.37</span>
<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">/usr/bin/mysqldump t2 -uroot -padmin --opt | mysql t2 -uroot -padmin -h 192.168.1.37</span>
<span style="color: #AEAEAE;">#</span><span style="color: #AEAEAE;">dump to slave ,(&#38656;&#35201;&#25552;&#21069;&#22312;slave &#19978;&#24314;&#19978;&#31354;&#24211;t1,t2)</span>
 <span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">&#23548;&#23436;&#25968;&#25454;&#20043;&#21518; &#35299;&#38145;&#34920;</span>
unlock tables;
</pre>
</div>
</div>
</div>
<div id="outline-container-org1107f5f" class="outline-3">
<h3 id="org1107f5f">slave 上的操作</h3>
<div class="outline-text-3" id="text-org1107f5f">
<p>
首先完成 t1,t2 两个数据库数据的同步<br />
</p>
<div class="org-src-container">
<pre class="src src-sh">create database t1;
use t1;
source t1.sql

create database t2;
use t2;
source t2.sql
</pre>
</div>
<p>
然后 根据master 上  show master status 获得的数据<br />
</p>
<div class="org-src-container">
<pre class="src src-sh">change master to <span style="color: #40E0D0;">master_host</span>=<span style="color: #ffa07a;">'192.168.1.132'</span>,<span style="color: #40E0D0;">master_user</span>=<span style="color: #ffa07a;">'slave'</span>,<span style="color: #40E0D0;">master_password</span>=<span style="color: #ffa07a;">'slave'</span>,<span style="color: #40E0D0;">master_log_file</span>=<span style="color: #ffa07a;">'mysql-bin.000005'</span>,<span style="color: #40E0D0;">master_log_pos</span>=2147;
start slave;  <span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">&#24320;&#22987;&#20445;&#25345;&#21516;&#27493;</span>
</pre>
</div>
<p>
此时在从库上<br />
</p>
<div class="org-src-container">
<pre class="src src-sh">show slave status \G;
</pre>
</div>
<blockquote>
<p>
mysql&gt; show slave status \G;<br />
	Slave_IO_Running: Yes<br />
	Slave_SQL_Running: Yes<br />
</p>
</blockquote>
<p>
当 Slave_IO_Running 与Slave_SQL_Running 状态是Yes 的时候 就算配置完成了<br />
可以试着在master 插入数据 看看slave 上数据是否得到同步<br />
</p>
</div>
</div>
<div id="outline-container-orgcc6f488" class="outline-3">
<h3 id="orgcc6f488">当出现主从不一致的时候的做法，</h3>
<div class="outline-text-3" id="text-orgcc6f488">
<p>
stop slave;<br />
#表示跳过一步错误，后面的数字可变<br />
set global sql_slave_skip_counter =1;<br />
start slave;<br />
</p>
</div>
</div>
</div>
<div id="outline-container-orgba920ac" class="outline-2">
<h2 id="orgba920ac">mysql热备做DR</h2>
<div class="outline-text-2" id="text-orgba920ac">
</div>
<div id="outline-container-org4265170" class="outline-3">
<h3 id="org4265170">在master db上使用mysqldump构建基于时间点的一致性全备</h3>
<div class="outline-text-3" id="text-org4265170">
<p>
mysqldump -uroot -pPASSWORD &#x2013;single-transaction &#x2013;master-data=2 &#x2013;skip-opt &#x2013;create-option -B item &gt; dump.sql<br />
</p>
</div>
</div>

<div id="outline-container-org539c150" class="outline-3">
<h3 id="org539c150">scp该sql文件到slave dr上面</h3>
</div>

<div id="outline-container-org263caba" class="outline-3">
<h3 id="org263caba">在slave dr上把全备的数据入库</h3>
<div class="outline-text-3" id="text-org263caba">
<p>
mysql -uroot -pPASSWORD &#x2013;default-character-set=latin1 &lt; dump.sql<br />
</p>
</div>
</div>

<div id="outline-container-orgf9466c8" class="outline-3">
<h3 id="orgf9466c8">在master db上执行授权语句</h3>
<div class="outline-text-3" id="text-orgf9466c8">
<p>
GRANT REPLICATION SLAVE, REPLICATION CLIENT ON <b>.</b> TO 'repl'@'slave1ip' IDENTIFIED BY 'pass'<br />
</p>
</div>
</div>

<div id="outline-container-orgeb9593f" class="outline-3">
<h3 id="orgeb9593f">在slave dr上设置热备关系</h3>
<div class="outline-text-3" id="text-orgeb9593f">
<p>
CHANGE MASTER TO<br />
  MASTER_HOST='masterIP',<br />
  MASTER_USER='root',<br />
  MASTER_PASSWORD='pass，<br />
  MASTER_LOG_FILE='binlog.022804',<br />
  MASTER_LOG_POS=98;<br />
start slave;<br />
</p>
</div>
</div>

<div id="outline-container-orgff3b962" class="outline-3">
<h3 id="orgff3b962">注：其中pos和file参数可以从mysqldump出来的sql文件前25行了解到</h3>
<div class="outline-text-3" id="text-orgff3b962">
<p>
head -25<br />
</p>
</div>
</div>

<div id="outline-container-org18fce64" class="outline-3">
<h3 id="org18fce64">使用show slave status\G 查看slave的情况</h3>
<div class="outline-text-3" id="text-org18fce64">
<p>
说明：上述的步骤是简单的热备做dr的步骤，有常见需要注意的问题<br />
1）mysqldump生成全备sql时需要注意&#x2013;single-transaction &#x2013;master-data等参数，详细可以参见mysqldump &#x2013;help<br />
2）全备入库时，需要设置&#x2013;default-character-set，使用一致的字符集<br />
</p>

<p>
先前在使用mysqldump的时候，没有加任何选项，查看dump出来的文件，发现每<br />
个table的insert语句被lock tables write和unlock tables包住。mysqldump在<br />
备份的时候，居然锁表！如果这张表非常大，在dump的过程中，其他线程岂不是<br />
不能写数据？看了下mysql的manual，发现&#x2013;lock-tables默认是True，可以使<br />
用&#x2013;skip-opt选项来屏蔽&#x2013;lock-tables。另外，我们很多时候需要基于时间点<br />
的备份，如早上9点，这时，可以使用&#x2013;single-transaction选项，这个选项可<br />
以在dump之前发出一个BEGIN语句，获取一个短暂的全局写锁，可以所有事务性<br />
数据库的一致性（内部应该是使用snapshot来实现，待求证），另外通过指<br />
定&#x2013;master-data=2，可以在dump文件中用注释的方式指定当前dump快照使用的<br />
binlog文件和位置，联合&#x2013;single-transaction和&#x2013;master-data两个选项，可<br />
以实现基于时间点的备份和恢复，特别是做热备。<br />
</p>

<p>
[注意]&#x2013;skip-opt禁用了很多默认的选项，如&#x2013;create-option等，其<br />
中&#x2013;create-option是比较重要的属性，如果该选项被disable掉，则在dump出来<br />
的table会少了auto-increment等字段属性。<br />
</p>


<blockquote>
<p>
&#x2013;single-transaction<br />
		    Creates a consistent snapshot by dumping all tables in a<br />
		    single transaction. Works ONLY for tables stored in<br />
		    storage engines which support multiversioning (currently<br />
		    only InnoDB does); the dump is NOT guaranteed to be<br />
		    consistent for other storage engines. While a<br />
		    &#x2013;single-transaction dump is in process, to ensure a<br />
		    valid dump file (correct table contents and binary log<br />
		    position), no other connection should use the following<br />
		    statements: ALTER TABLE, DROP TABLE, RENAME TABLE,<br />
		    TRUNCATE TABLE, as consistent snapshot is not isolated<br />
		    from them. Option automatically turns off &#x2013;lock-tables.<br />
&#x2013;master-data[=#]   This causes the binary log position and filename to be<br />
		    appended to the output. If equal to 1, will print it as a<br />
		    CHANGE MASTER command; if equal to 2, that command will<br />
		    be prefixed with a comment symbol. This option will turn<br />
		    &#x2013;lock-all-tables on, unless &#x2013;single-transaction is<br />
		    specified too (in which case a global read lock is only<br />
		    taken a short time at the beginning of the dump; don't<br />
		    forget to read about &#x2013;single-transaction below). In all<br />
		    cases, any action on logs will happen at the exact moment<br />
		    of the dump. Option automatically turns &#x2013;lock-tables<br />
		    off.<br />
</p>
</blockquote>
</div>
</div>
</div>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2015-10-19</span>
        <span title="last modification date" class="post-info">2021-09-10</span>
        <span title="tags" class="post-info"><a href="/tags/mysql/">Mysql</a></span>
        <span title="author" class="post-info">纪秀峰</span>
      </div>
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          //var disqus_developer = 1;
          var disqus_identifier = "/blog/mysql-slave.html";
          var disqus_url = "http://jixiuf.github.io/blog/mysql-slave.html";
          var disqus_shortname = 'jixiuf';
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <div class="ds-thread"></div>
        <script type="text/javascript">
          var duoshuoQuery = {short_name:'jixiuf'};
          (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = 'http://static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
          || document.getElementsByTagName('body')[0]).appendChild(ds);
          })();
        </script>
      </section>
      <script src="http://code.jquery.com/jquery-latest.min.js"></script>
      <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script> -->
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="/media/js/main.js"></script>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x (<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
          Copyright &copy; 2012 - <span id="footerYear"></span> <a href="mailto:jixiuf &lt;at&gt; gmail &lt;dot&gt; com">纪秀峰</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

  </body>
</html>
