<!DOCTYPE html>
<html lang="zh">
  <head>
    <title>vitess介绍 - 拾遗笔记</title>
    <meta charset="utf-8" />
    <meta name="author" content="纪秀峰" />
    <meta name="description" content="vitess介绍" />
    <meta name="keywords" content="Vitess Golang Mysql" />
    <link rel="stylesheet" href="/media/css/main.css" type="text/css">
    <!-- <link rel="stylesheet" href="/media/css/prettify.css" type="text/css"> -->
  </head>
  <body class="container">
<script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- ji -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-6633117582073327"
     data-ad-slot="1629980291"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="/">拾遗笔记</a></h1>
        <p></p>
        <ul>
          <li><a href="/blog/">Blog</a></li>
          <li><a href="/tags/">Tags</a></li>
          <li><a href="/about/">About</a></li>
          <li><a href="http://github.com/jixiuf">GitHub</a></li>
          <li><a href="/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="http://www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="jixiuf.github.io">
        </form>
      </header>
    </div>

<div>
<div class="post">
<h1>vitess介绍</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org791ecfc">几种mysql 水平扩展架构比较</a></li>
<li><a href="#org8c36ee6">架构</a></li>
<li><a href="#orge6e9607">vitess 与mysql 的对比</a></li>
<li><a href="#orge793a22">vitess 与nosql对比</a></li>
<li><a href="#org072e88f">Keyspace</a></li>
<li><a href="#org138879c">Keyspace Id</a></li>
<li><a href="#org0b1401a">Shard</a></li>
<li><a href="#org51f9a8a">Tablet</a></li>
<li><a href="#org1685a21">Shard graph</a></li>
<li><a href="#orgbd55163">Replication graph</a></li>
<li><a href="#orga5fe54e">Serving graph</a></li>
<li><a href="#org79d4986">Topology Service(拓扑结构) etcd or zookeeper</a>
<ul>
<li><a href="#org4e7f22e">etcd 相关</a></li>
</ul>
</li>
<li><a href="#org5ac8f39">Cell(data center)</a></li>
</ul>
</div>
</div>
<div id="outline-container-org791ecfc" class="outline-2">
<h2 id="org791ecfc">几种mysql 水平扩展架构比较</h2>
<div class="outline-text-2" id="text-org791ecfc">
<p>
<a href="http://songwie.com/articlelist/44">http://songwie.com/articlelist/44</a><br />
<a href="http://www.tuicool.com/articles/miuq63E">http://www.tuicool.com/articles/miuq63E</a><br />
<a href="http://www.guokr.com/blog/475765/">http://www.guokr.com/blog/475765/</a><br />
<a href="http://m.open-open.com/m/news/view/f948e2">http://m.open-open.com/m/news/view/f948e2</a><br />
<a href="http://ju.outofmemory.cn/entry/221124">http://ju.outofmemory.cn/entry/221124</a><br />
</p>
</div>
</div>
<div id="outline-container-org8c36ee6" class="outline-2">
<h2 id="org8c36ee6">架构</h2>
<div class="outline-text-2" id="text-org8c36ee6">
<p>
<img src="/assets/blog/go_vitess.html/VitessOverview.png" alt="VitessOverview.png" /><br />
vtgate 可以认为是网关,client 只需要与vtgate 连接即可<br />
vtgate 会把相应的sql 路由到相应的vttablet 进行查询 执行等<br />
vtgate 可以启动多个，来做负载均衡<br />
vttablet 可以认为是在mysql 前面挡了一层，一个vttablet 对应一个mysql 实例<br />
主要提供连接池、查询重写、查询去重、以及相应的管理操作<br />
vtctl 命令行， 提供管理vitess 的命令等，包括查询master-slave关系，sharding 信息<br />
建表，执行sharding resharding ，执行failover(切换主从关系等)等操作。<br />
vtworker<br />
</p>

<p>
vtworker 执行一些需要长时间运行的进程。它支持一个插件式的架构并提供<br />
了第三方库，这样你可以轻易选择要使用的 tablet。该插件可以用于以下类<br />
型的工作：<br />
resharding differ：在水平分片的分割以及合并时核查数据完整性的工作<br />
vertical split differ：在垂直分割以及合并时核查数据完整性的工作<br />
vtworker 还允许您轻松地添加其他验证程序。你可以进行 in-tablet 完整<br />
性检查以验证外键之类的关联关系或者跨片完整性检查，例如，一个密钥空<br />
间里的索引表所指向的数据在另一个密钥空间里。<br />
</p>

<p>
mysqlctl: Manage MySQL instances<br />
zk zkctl 管理zookeeper 的工具等<br />
</p>
</div>
</div>

<div id="outline-container-orge6e9607" class="outline-2">
<h2 id="orge6e9607">vitess 与mysql 的对比</h2>
<div class="outline-text-2" id="text-orge6e9607">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">mysql</th>
<th scope="col" class="org-left">vitess</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">每个 MySql 连接都有一个内存开销，其范围介于 256KB 到几乎 3MB 之间，这取决于你所使用的 MySql 版本。随着你的用户群的增长，你需要增加内存以支撑增加的那些连接，但增加内存无助于提高查询速度。此外，在获取这些连接的时候还有大量的 CPU 开销。</td>
<td class="org-left">Vitess 所用的 SQL 解析器使用了一组可配置的规则对可能会降低数据库性能的查询进行重写。</td>
</tr>

<tr>
<td class="org-left">低效的写查询，比如一些没有设置一个限制的写查询，将会对所有用户的数据库性能产生负面影响。</td>
<td class="org-left">Vitess 所用的 SQL 解析器使用了一组可配置的规则对可能会降低数据库性能的查询进行重写。</td>
</tr>

<tr>
<td class="org-left">分片是一个对你的数据进行分区来提高可扩展性和性能的过程。MySql 不支持分片，要求你自己去编写分片代码并在你自己的应用程序中嵌入分片逻辑。</td>
<td class="org-left">Vitess 使用基于范围的分片。它同时支持水平和垂直的重新切分，完成大多数数据的转换只需要仅仅几秒钟的只读的停机时间。Vitess 甚至可以适应你现有的一个自定义分片方案。</td>
</tr>

<tr>
<td class="org-left">MySql 集群为保证可用性采用的是主从复制，有一个主数据库和几个副本数据库。主库宕机，某台从库将成为新的主库。这个要求你去管理数据库的生命周期并将当前的系统状态传达给你自己的应用程序。</td>
<td class="org-left">Vitess 帮你管理数据库的生命周期。它支持并自动应对各种场景，包括主库故障转移以及数据备份。</td>
</tr>

<tr>
<td class="org-left">一个 MySQL 集群可以为不同的工作负载自定义数据库配置，比如一个只写的主库，满足 web 客户端快只读的副本库，可用于批处理作业的慢只读副本库，诸如此类。如果数据库已经水平切分，需要为每个分片重复安装过程，而且应用程序中需要内置如何才能找到合适的库的相关逻辑。</td>
<td class="org-left">Vitess 使用一个数据存储一致性的拓扑支持，比如 etcd 或者 ZooKeeper。这也就意味着集群视图始终是最新的而且对于不同的客户端也能始终保证其一致性。Vitess 还提供了一个高效地将查询路由给最适合的 MySql 实例的代理。</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-orge793a22" class="outline-2">
<h2 id="orge793a22">vitess 与nosql对比</h2>
<div class="outline-text-2" id="text-orge793a22">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">NoSql</td>
<td class="org-left">Vitess</td>
</tr>

<tr>
<td class="org-left">NoSQL 数据库不定义数据库表之间的关系，并且仅支持 SQL 语言的一个子集。</td>
<td class="org-left">Vitess 并不是一个简单的键值存储。它支持复杂的查询语句，比如 where 子句、联接查询、聚集功能等等。</td>
</tr>

<tr>
<td class="org-left">NoSQL 数据库不支持事务。</td>
<td class="org-left">Vitess 支持单个分片内的事务。Vitess 团队也正在探索使用两阶段提交支持跨分片事务的可行性。</td>
</tr>

<tr>
<td class="org-left">NoSQL 解决方案拥有定制的 API，这将导致定制的架构、应用程序和工具。</td>
<td class="org-left">Vitess 仅添加了极小的变化到 MySql，一个绝大多数的人们都已经习惯使用的数据库。</td>
</tr>

<tr>
<td class="org-left">相比 MySql 来讲，NoSQL 提供的数据库索引支持是有限的</td>
<td class="org-left">Vitess 允许你使用 MySql 的所有索引功能来优化查询性能。</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org072e88f" class="outline-2">
<h2 id="org072e88f">Keyspace</h2>
<div class="outline-text-2" id="text-org072e88f">
<p>
一个keyspace 就是一个逻辑上的 mysql database 直接对应一个或多个mysql database名。<br />
从一个keyspace 读取数据 就像从一个mysql database 一样，<br />
不同的是vitess会来决定读取操作是从主库读,还是从库读，<br />
vitess 使你的代码简化到似乎跟从一个mysql database读取数据一样简单。<br />
如果做了sharding ,一个keyspace 会对应多个mysql database ,<br />
这种情况一个读操作可能仅仅是从其中一个mysql database 读。<br />
</p>
</div>
</div>
<div id="outline-container-org138879c" class="outline-2">
<h2 id="org138879c">Keyspace Id</h2>
<div class="outline-text-2" id="text-org138879c">
<p>
keyspace_id 是一个keyspace 的id列，它可以标志一个user,produce等。keyspace_id的类型有多种。<br />
做sharding 时， 一个keyspace 的所有表都要包含keyspace_id列，vitess 根据keyspace_id做sharding<br />
且同一个keyspace_id 只会出现个一个分片上.<br />
keyspace_id 可以不是主键 ，可以不是索引<br />
如果不打算对database 做sharding ，可以不定义keyspace_id<br />
一个keyspace_id 可以是unsigned 数字或 binary character column,对mysql 来说就是<br />
(unsigned bigint or varbinary in MySQL tables),似乎其他类型不能做keyspace_id<br />
不太确定 unsigned int 等可不可以<br />
vitess 用memcache作row cache 来提升查询命中率，往memcache存的时候应该会与keyspace_id有关<br />
这一卓越特性可以将在应用程序层自定义的缓存层实现给替换掉了。<br />
之前在某篇文章中看到说同一个database 不同的表之间keyspace_id也不能相同，否则往memcache取数据会乱<br />
后来翻看 vitess/go/vt/tabletserver/rowcache.go源码有这样一段,应该能证明这种说法不对。<br />
</p>
<div class="org-src-container">
<pre class="src src-go">type RowCache struct {
    tableInfo *TableInfo
    prefix    string
    cachePool *CachePool
}
func NewRowCache(tableInfo *TableInfo, cachePool *CachePool) *RowCache {
    prefix := strconv.FormatInt(cachePool.maxPrefix.Add(1), 36) + "."
    return &amp;RowCache{tableInfo, prefix, cachePool}
}
// Get fetches the values for the specified keys.
func (rc *RowCache) Get(ctx context.Context, keys []string) (results map[string]RCResult) {
    mkeys := make([]string, 0, len(keys))
    for _, key := range keys {
	if len(key) &gt; maxKeyLen {
	    continue
	}
	mkeys = append(mkeys, rc.prefix+key) // 看这里有加prefix
    }
    // ...
}
</pre>
</div>
</div>
</div>


<div id="outline-container-org0b1401a" class="outline-2">
<h2 id="org0b1401a">Shard</h2>
<div class="outline-text-2" id="text-org0b1401a">
<p>
一个Shard 就是一个分片， 某个keyspace的一部分，一个典型的shard ,包含一个master 和多个slaves.<br />
同一个Shard里的mysql 实例包含的数据应该是相同的，除了有延迟从库，slave 从库可以分担一部分只读流量<br />
（需要保证最终一致性），或者执行一些耗时的分析工作或者执行backup 恢复等操作。<br />
</p>

<p>
一个无shard 的space 可以认为是只有一个shard ,vitess 命名为shard 0,通过分片时N 取2^n<br />
vitess 支持动态resharding,即将一个shard 分成多个shard,这个过程中 源shard里的数据会被分成多份，<br />
最终源shard会被删掉<br />
</p>
</div>
</div>
<div id="outline-container-org51f9a8a" class="outline-2">
<h2 id="org51f9a8a">Tablet</h2>
<div class="outline-text-2" id="text-org51f9a8a">
<p>
一个tablet 包含<br />
</p>
<ol class="org-ol">
<li>一个mysql instance<br /></li>
<li>一个 vttablet instance<br /></li>
<li>一个可选的row cache  instance (memcache)<br /></li>
<li>其他一些特定的database 相关进程<br /></li>
</ol>

<p>
类型<br />
</p>
<ol class="org-ol">
<li>master 主库<br /></li>
<li>replica 低延迟的从库<br /></li>
<li>rdonly 延迟相对较高的只读库，主要执行一些后台耗时操作<br /></li>
<li>spare 暂时不工作的slave<br /></li>
</ol>
</div>
</div>
<div id="outline-container-org1685a21" class="outline-2">
<h2 id="org1685a21">Shard graph</h2>
<div class="outline-text-2" id="text-org1685a21">
<p>
Shard graph 的作用是 将keyspace_id map 到指定的shard 上。<br />
vitess 使用 range-based sharding 策略。vitess 在内存中通过一个查询表（lookup）来定位shard<br />
当keyspace_id 是均匀分布的时候最高效，最好使用hash 还不是自增的值作为keyspace_id<br />
</p>
</div>
</div>
<div id="outline-container-orgbd55163" class="outline-2">
<h2 id="orgbd55163">Replication graph</h2>
<div class="outline-text-2" id="text-orgbd55163">
<p>
作用是 定位master 与相应slave 。如果master 当掉能够及时找到一个slave 来作为master<br />
</p>
</div>
</div>
<div id="outline-container-orga5fe54e" class="outline-2">
<h2 id="orga5fe54e">Serving graph</h2>
<div class="outline-text-2" id="text-orga5fe54e">
<p>
作用是 列出所有可用的server ,主要从Shard graph 与Replication graph 中获取相应的信息<br />
VTGate 从Serving graph来决定从哪个server 执行相应的查询<br />
</p>
</div>
</div>
<div id="outline-container-org79d4986" class="outline-2">
<h2 id="org79d4986">Topology Service(拓扑结构) etcd or zookeeper</h2>
<div class="outline-text-2" id="text-org79d4986">
<p>
提供 lockin service ,目前vitess 主要支持 etcd 和zookeeper 来作为Topology Service<br />
并在其中存储 整个vitess 的拓扑结构信息<br />
可以通过 vtctl 命令行 或 vtctld(web接口) 来查看其中的信息<br />
</p>
<ol class="org-ol">
<li>存储 数据放在何处的 规则<br /></li>
<li>保证write 操作正确执行。<br /></li>
<li>保证vitess 可以透明的数据节点挂掉而不影响整个业务<br /></li>
<li>保证 一个数据中心作为一个整个 下线、重建<br /></li>
</ol>

<p>
vitess有一个global topology service 及每个data center(cell)一个的local topology service<br />
vitess client 设计为 只要接触local 即可<br />
</p>
<ul class="org-ul">
<li>global instance<br />
存一些基本不怎么变化的信息，包括keyspace_id与shard、以及主从关系<br />
主要用于 resharding 等操作。<br />
设计之初 global instance 就不常被用到。<br /></li>
<li>local instance<br />
存储本cell 内关与tablets 的数据，cell内serving graph信息 ,cell内的mysql 实例的主从关系信息等<br />
local instance 必須正常运转，才能保证vitess 提供正常的服务。<br /></li>
</ul>
</div>
<div id="outline-container-org4e7f22e" class="outline-3">
<h3 id="org4e7f22e">etcd 相关</h3>
<div class="outline-text-3" id="text-org4e7f22e">
<p>
需要在golbal topology 处注册某个cell 的local topology 在何处，<br />
然后启动 vttablets 时 才能正常启动<br />
比如example/kubernetes/etcd-controller-template.yaml中用这样一句来初始化<br />
</p>
<div class="org-src-container">
<pre class="src src-sh">etcdctl -C <span style="color: #ffa07a;">"http://etcd-global:4001"</span>  set <span style="color: #ffa07a;">"/vt/cells/{{cell}}"</span> <span style="color: #ffa07a;">"http://etcd-{{cell}}:4001"</span>
</pre>
</div>
<p>
比如cell 名为test 时<br />
</p>
<div class="org-src-container">
<pre class="src src-sh">etcdctl  set <span style="color: #ffa07a;">"/vt/cells/test"</span> <span style="color: #ffa07a;">"http://etcd-cell-test:2379"</span>
<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">&#20351;&#29992;&#20197;&#19979;&#21629;&#20196; &#26597;&#30475;&#35774;&#32622;&#30340;&#20540;&#26159;&#21542;&#25104;&#21151;</span>
etcdctl get /vt/cells/test
<span style="color: #AEAEAE;">#  </span><span style="color: #AEAEAE;">&#21487;&#20197;&#21152;&#27492;&#20197;&#23044; &#25351;&#23450;&#36830;&#21738;&#20010;etcd ,&#21363;global etcd &#22312;&#21487;&#22788;</span>
<span style="color: #AEAEAE;">#</span><span style="color: #AEAEAE;">-C "http://etcd-global:4001"</span>
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org5ac8f39" class="outline-2">
<h2 id="org5ac8f39">Cell(data center)</h2>
<div class="outline-text-2" id="text-org5ac8f39">
<p>
一般指某一个区域内的 服务与网络基础设施集，<br />
vitess 可以优雅的处理某一个cell 挂掉<br />
</p>

<p>
每个cell 都有一个local topology server,其中包含了 cell内的tablets 信息，信息足够保证一个cell 停掉并重建<br />
vitess 限制跨cell的数据传输（包括数据与元数据信息）,vitess 不支持路由client 到特定节点的功能<br />
</p>
</div>
</div>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2016-02-02</span>
        <span title="last modification date" class="post-info">2021-09-10</span>
        <span title="tags" class="post-info"><a href="/tags/vitess/">Vitess</a>, <a href="/tags/golang/">Golang</a>, <a href="/tags/mysql/">Mysql</a></span>
        <span title="author" class="post-info">纪秀峰</span>
      </div>
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          //var disqus_developer = 1;
          var disqus_identifier = "/blog/go_vitess.html";
          var disqus_url = "http://jixiuf.github.io/blog/go_vitess.html";
          var disqus_shortname = 'jixiuf';
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <div class="ds-thread"></div>
        <script type="text/javascript">
          var duoshuoQuery = {short_name:'jixiuf'};
          (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = 'http://static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
          || document.getElementsByTagName('body')[0]).appendChild(ds);
          })();
        </script>
      </section>
      <script src="http://code.jquery.com/jquery-latest.min.js"></script>
      <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script> -->
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="/media/js/main.js"></script>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x (<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
          Copyright &copy; 2012 - <span id="footerYear"></span> <a href="mailto:jixiuf &lt;at&gt; gmail &lt;dot&gt; com">纪秀峰</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

  </body>
</html>
