<!DOCTYPE html>
<html lang="zh">
  <head>
    <title>linux拾遗 - 拾遗笔记</title>
    <meta charset="utf-8" />
    <meta name="author" content="纪秀峰" />
    <meta name="description" content="linux拾遗" />
    <meta name="keywords" content=":Linux:" />
    <link rel="stylesheet" href="/media/css/main.css" type="text/css">
    <!-- <link rel="stylesheet" href="/media/css/prettify.css" type="text/css"> -->
  </head>
  <body class="container">
<script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- ji -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-6633117582073327"
     data-ad-slot="1629980291"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="/">拾遗笔记</a></h1>
        <p></p>
        <ul>
          <li><a href="/blog/">Blog</a></li>
          <li><a href="/tags/">Tags</a></li>
          <li><a href="/about/">About</a></li>
          <li><a href="http://github.com/jixiuf">GitHub</a></li>
          <li><a href="/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="http://www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="jixiuf.github.io">
        </form>
      </header>
    </div>

<div>
<div class="post">
<h1>linux拾遗</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org3480e5b">几个工具</a></li>
<li><a href="#orge0a8deb">IOSTAT 介绍</a></li>
<li><a href="#org1040316">VMSTAT 介绍</a></li>
<li><a href="#org141553f">几个性能相关工具</a></li>
<li><a href="#org88a3965">free 命令详解</a></li>
<li><a href="#org7a651dd">使某一目录下创建的所有文件目录的groupname 都是 当前用户所属的组</a></li>
<li><a href="#orgaf3cae6">umask</a></li>
<li><a href="#orga64a61a">setfacl</a></li>
<li><a href="#org3293365">mbr and dd</a></li>
<li><a href="#org8d65187">ctags</a></li>
<li><a href="#org83b65d2">nmap</a></li>
<li><a href="#org68a7b58">tcpdump</a></li>
<li><a href="#org73055af">mac shutdown</a></li>
<li><a href="#orge2e2317">linux下分辨率调整</a></li>
<li><a href="#org84c35d8">通过ssh 连接远程机器上的mysql 等</a></li>
<li><a href="#org8a8a690">iptables 作端口转发</a></li>
<li><a href="#org92d5efb">ssh socat</a></li>
<li><a href="#orge382e71">ssh tunnel</a>
<ul>
<li><a href="#orgd04f7c9">ssh 反向tunnel 实现借助外网机访问内网机服务器</a></li>
</ul>
</li>
<li><a href="#org884cce9">tsocks 配置</a></li>
<li><a href="#orgee69b2f">adb shell</a></li>
<li><a href="#org796cb91">curl demo</a></li>
<li><a href="#org92f7748">time sync</a></li>
<li><a href="#orgd52bbcc">sed 一些用法</a></li>
<li><a href="#orgbe55eb3">grep</a>
<ul>
<li><a href="#org1f0a472">grep -v 过滤 不匹配的行</a></li>
<li><a href="#org30735a4">grep -P 以perl正则来匹配(linux支持,mac不支持)</a></li>
<li><a href="#orgfa76ac5">grep [a,A]..[b,B]* file  在文件中查找a（或A）开头，第四个字母为b（或B）的所有单词</a></li>
<li><a href="#orgfbe1d60">grep -E 'string1|string2' file        搜寻文件中或者存在string1或者存在string2的行</a></li>
<li><a href="#org6ffa681">利用grep -c 来作instr()用</a></li>
</ul>
</li>
<li><a href="#org0943c6e">find</a></li>
<li><a href="#orged9d63a">“.”点号替代单个字符</a></li>
<li><a href="#org3622f5a">shell for if example</a></li>
<li><a href="#org172e61b">用python 格式化json</a></li>
<li><a href="#org40e85a7">awk 怎么去除如果第一列相同，则只取一行？</a></li>
<li><a href="#orgfa0edc8">awk 替换</a></li>
<li><a href="#orgeb656d0">awk 在指定的行添加内容添加行</a></li>
<li><a href="#orgd7c2b8b">压测用工具</a>
<ul>
<li><a href="#orgbc5e43c">ab -n 1000000 -c 1000 -p /tmp/a -T application/json  -H "X-UID: 1000000013" http://diary.dev.igetget.com/diary/v1/data/list</a></li>
<li><a href="#org90a9263">siege -c 1000  -b -q -r 1000000   -H "X-Uid: 1000100366" -H "X-Av: 3.0.9" -H "X-D: aaa" -f choicesnow.txt</a></li>
</ul>
</li>
<li><a href="#orgcdf7735">ab http压测</a></li>
<li><a href="#org68135a3">tcpcopy 线上数据导入测度服进行压测</a></li>
<li><a href="#org3423fe4">使用charles在移动设备上捕获https数据包</a></li>
<li><a href="#org803ce54">如何应对三高</a>
<ul>
<li><a href="#orgc9e1764">高并发</a></li>
<li><a href="#orgd67eccd">高可用</a></li>
</ul>
</li>
<li><a href="#orga77c5df">ssh 避免输入密码的办法</a></li>
</ul>
</div>
</div>
<div id="outline-container-org3480e5b" class="outline-2">
<h2 id="org3480e5b">几个工具</h2>
<div class="outline-text-2" id="text-org3480e5b">
<ul class="org-ul">
<li>nload 查看网卡流量<br /></li>
<li>nethogs iptrafr iftop 查看具体的进程发包收包情况<br />
sudo yum install nethogs<br /></li>
<li>rkhunter linux 安全工具，扫描后门程序（需要刚装机时建立样本进行对比)<br />
rkhunter &#x2013;propupd 刚装完机 用此命令建立样本<br />
rkhunter -c   check<br />
rkhunter –-update  更新数据库，<br /></li>

<li>lsof -i:8888  查看兼听8888端口的程序<br /></li>
<li>top 按M按内存排序<br /></li>
<li>tmux<br /></li>
<li>nc -u localhost 7777 nc 可以跟telnet 一样， 不过支持udp telnet<br /></li>
<li>创建虚拟ftp 用户 ftpasswd &#x2013;passwd &#x2013;file=/etc/ftpd.passwd &#x2013;name=ftp  &#x2013;home=/home/ftp &#x2013;shell=/bin/false &#x2013;uid 508<br /></li>
<li><p>
exit code $?  echo $?<br />
[ $? -eq 0 ] || exit $?; # exit for none-zero return code<br />
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">this will trap any errors or commands with non-zero exit status</span>
<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">by calling function catch_errors()</span>
<span style="color: #FBDE2D;">trap</span> catch_errors ERR;

<span style="color: #AEAEAE;">#</span>
<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">... the rest of the script goes here</span>
<span style="color: #AEAEAE;">#</span>

<span style="color: #FBDE2D;">function</span> <span style="color: #FF6400;">catch_errors</span>() {
<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">do whatever on errors</span>
<span style="color: #AEAEAE;">#</span>
<span style="color: #AEAEAE;">#</span>
<span style="color: #F8F8F8;">echo</span> <span style="color: #ffa07a;">"script aborted, because of errors"</span>;
<span style="color: #FBDE2D;">exit</span> $<span style="color: #40E0D0;">?</span>;
}
find /asda
<span style="color: #F8F8F8;">echo</span> <span style="color: #ffa07a;">"oo"</span>
</pre>
</div></li>

<li>strace -p 29064 &gt;/tmp/strace.log 2&gt;&amp;1<br />
cat strace.log|cut -f 1 -d "("|sort|uniq -c<br />
统计某进程系统调用的信息 ，比如归个系统调用多<br /></li>
</ul>


<ul class="org-ul">
<li>tmux attach<br />
C-bd  退出<br />
C-b0 C-b1 C-b2  切tag<br />
C-bs list sessions<br />
C-bn C-bp next prev<br />
C-bc 新建tag<br /></li>
</ul>
</div>
</div>



<div id="outline-container-orge0a8deb" class="outline-2">
<h2 id="orge0a8deb">IOSTAT 介绍</h2>
<div class="outline-text-2" id="text-orge0a8deb">
<p>
Iostat（Input Output statistics）反映了磁盘I/O情况和CPU 活动。<br />
基本语法： iostat &lt;options&gt; interval count<br />
</p>

<p>
option - 让你指定所需信息的设备，像磁盘、cpu或者终端(-d , -c , -t or<br />
-tdc ) 。x 选项给出了完整的统计结果。iostat的默认参数是tdc(terminal,<br />
disk, and CPU)。如果任何其他的选项被指定，这个默认参数将被完全替代。<br />
</p>


<p>
-k 以kb的形式显示<br />
</p>

<p>
如 iostat -d -k  -x 1 10<br />
interval – 统计运行的间隔时间（秒），<br />
count – 统计运行的次数<br />
</p>



<p>
参数说明：<br />
rrqm/s:   每秒进行 merge 的读操作数目。<br />
wrqm/s:  每秒进行 merge 的写操作数目。<br />
r/s:           每秒完成的读 I/O 设备次数。<br />
w/s:         每秒完成的写 I/O 设备次数。<br />
rsec/s:    每秒读扇区数。即 delta(rsect)/s<br />
wsec/s:  每秒写扇区数。即 delta(wsect)/s<br />
rkB/s:      每秒读K字节数。是 rsect/s 的一半，因为每扇区大小为512字节。<br />
wkB/s:    每秒写K字节数。是 wsect/s 的一半。<br />
avgrq-sz: 平均每次设备I/O操作的数据大小 (扇区)。<br />
avgqu-sz: 平均I/O队列长度。即 delta(aveq)/s/1000 (因为aveq的单位为毫秒)。<br />
await:    平均每次设备I/O操作的等待时间 (毫秒)。<br />
svctm:   平均每次设备I/O操作的服务时间 (毫秒)。<br />
%util:      一秒中有百分之多少的时间用于 I/O 操作，或者说一秒中有多少时间 I/O 队列是非空的。<br />
比如当发现util 比较高时， 我们知道io操作比较频繁<br />
</p>

<p>
 iostat -d -k  -x 1 100<br />
<img src="/assets/blog/linux.html/linux-2017-09-21-21-50-02.png" alt="linux-2017-09-21-21-50-02.png" /><br />
可以用lsof /dev/vdb 查看当前io主要针对的文件是什么，比如发现日志比较费io<br />
<img src="/assets/blog/linux.html/linux-2017-09-21-21-50-54.png" alt="linux-2017-09-21-21-50-54.png" /><br />
</p>

<p>
注意：<br />
</p>

<p>
输出结果的第一行是从系统启动到现在为止的这段时间的结果，接下去的每一行<br />
是interval时间段内的结果。Kernel里有一组计数器用来跟踪这些值。所以我们<br />
在取性能指标的时候要注意第一行指标的特殊性。<br />
</p>

<p>
SUSE 10 和9 iostat 参数数量略有不同，suse 10 多出rkB/s ,wkB/两个参数，<br />
不过意义不大，因为完全可以通过rsec/s，wsec/s计算得出。<br />
</p>

<p>
现在的监控脚本中已经利用IOSTAT采集每秒设备的读写次数，IO队列长度，IO操<br />
作哦等待时间以及IO利用率等性能指标上报至 二级网管系统及DB性能平台<br />
（db.ied.com）其中IO利用率已经作为重要的指标成为衡量DB健康度的标准<br />
</p>
</div>
</div>

<div id="outline-container-org1040316" class="outline-2">
<h2 id="org1040316">VMSTAT 介绍</h2>
<div class="outline-text-2" id="text-org1040316">
<p>
Vmstat（Virtual Memory Statistics）反映了进程的虚拟内存、虚拟内存、磁盘、trap和cpu的活动情况<br />
基本语法：vmstat &lt;options&gt; interval count<br />
</p>

<p>
option - 让你指定所需的信息类型，例如 paging -p , cache -c ,.interrupt<br />
-i etc. 如果没有指定选项，将会显示进程、内存、页、磁盘、中断和cpu信息。<br />
</p>



<p>
报告说明：<br />
</p>

<ul class="org-ul">
<li><p>
procs<br />
</p>
<ol class="org-ol">
<li>r:<br /></li>
</ol>
<p>
运行的和等待(CPU时间片)运行的进程数，这个值也可以判断是否需要增加CPU(长期大于1)<br />
</p>
<ol class="org-ol">
<li>b:<br /></li>
</ol>
<p>
处于不可中断状态的进程数，常见的情况是由IO引起的<br />
</p></li>
<li>memory<br />
<ol class="org-ol">
<li>swpd: 切换到交换内存上的内存(默认以KB为单位)<br />
如果 swpd 的值不为0，或者还比较大，比如超过100M了，但是 si, so 的值长期为 0，这种情况我们可以不用担心，不会影响系统性能。<br /></li>
<li></li>

<li>free: 空闲的物理内存<br /></li>
<li>buff: 作为buffer cache的内存，对块设备的读写进行缓冲<br /></li>
<li>cache: 作为page cache的内存, 文件系统的cache<br />
如果 cache 的值大的时候，说明cache住的文件数多，如果频繁访问到的文件都能被cache住，那么磁盘的读IO bi 会非常小。<br /></li>
</ol></li>
<li><p>
Swap<br />
</p>
<ol class="org-ol">
<li>si: 交换内存使用，由磁盘调入内存<br /></li>
<li>so: 交换内存使用，由内存调入磁盘<br /></li>
</ol>
<p>
内存够用的时候，这2个值都是0，如果这2个值长期大于0时，系统性能会受到影响。磁盘IO和CPU资源都会被消耗。<br />
常有人看到空闲内存(free)很少或接近于0时，就认为内存不够用了，实际上不能光看这一点的，还要结合si,so，如果free很少，但是si,so也很少(大多时候是0)，那么不用担心，系统性能这时不会受到影响的。<br />
</p></li>
<li><p>
io<br />
</p>
<ol class="org-ol">
<li>bi: 从块设备读入的数据总量(读磁盘) (KB/s)，<br /></li>
<li>bo: 写入到块设备的数据总理(写磁盘) (KB/s)<br /></li>
</ol>
<p>
随机磁盘读写的时候，这2个 值越大（如超出1M），能看到CPU在IO等待的值也会越大<br />
</p></li>
<li>system<br />
<ol class="org-ol">
<li>in: 每秒产生的中断次数<br /></li>
<li>cs: 每秒产生的上下文切换次数<br />
上面这2个值越大，会看到由内核消耗的CPU时间会越多<br /></li>
</ol></li>
<li>cpu<br />
<ol class="org-ol">
<li>us: 用户进程消耗的CPU时间百分比<br />
us 的值比较高时，说明用户进程消耗的CPU时间多，但是如果长期超过50% 的使用，那么我们就该考虑优化程序算法或者进行加速了<br /></li>
<li>sy: 内核进程消耗的CPU时间百分比<br />
sy 的值高时，说明系统内核消耗的CPU资源多，这并不是良性的表现，我们应该检查原因。<br /></li>
<li>wa: IO等待消耗的CPU时间百分比<br />
wa 的值高时，说明IO等待比较严重，这可能是由于磁盘大量作随机访问造成，也有可能是磁盘的带宽出现瓶颈(块操作)。<br /></li>
<li>id: CPU处在空闲状态时间百分比<br /></li>
</ol></li>
</ul>
</div>
</div>

<div id="outline-container-org141553f" class="outline-2">
<h2 id="org141553f">几个性能相关工具</h2>
<div class="outline-text-2" id="text-org141553f">
<p>
dstat -tlcnimr &#x2013;tcp -D xvdc<br />
<img src="/assets/blog/linux.html/linux-2017-12-13-12-36-26.png" alt="linux-2017-12-13-12-36-26.png" /><br />
mpstat -P ALL 1<br />
<img src="/assets/blog/linux.html/linux-2017-12-13-12-36-41.png" alt="linux-2017-12-13-12-36-41.png" /><br />
pidstat 1<br />
<img src="/assets/blog/linux.html/linux-2017-12-13-12-36-49.png" alt="linux-2017-12-13-12-36-49.png" /><br />
iostat -xz 1<br />
vmstat 1<br />
</p>
</div>
</div>

<div id="outline-container-org88a3965" class="outline-2">
<h2 id="org88a3965">free 命令详解</h2>
<div class="outline-text-2" id="text-org88a3965">
<p>
因为LINUX的内核机制，一般情况下不需要特意去释放已经使用的cache。这些cache起来的内容可以增加文件以及的读写速度。<br />
先说下free命令怎么看内存<br />
</p>

<p>
[root@yuyii proc]# free<br />
total used free shared buffers cached<br />
Mem: 515588 295452 220136 0 2060 64040<br />
-/+ buffers/cache: 229352 286236<br />
Swap: 682720 112 682608<br />
</p>

<p>
其中第一行用全局角度描述系统使用的内存状况：<br />
total——总物理内存<br />
used——已使用内存，一般情况这个值会比较大，因为这个值包括了cache+应用程序使用的内存<br />
free——完全未被使用的内存<br />
shared——应用程序共享内存<br />
buffers——缓存，主要用于目录方面,inode值等（ls大目录可看到这个值增加）<br />
cached——缓存，用于已打开的文件<br />
note:<br />
total=used+free<br />
used=buffers+cached (maybe add shared also)<br />
</p>

<p>
第二行描述应用程序的内存使用：<br />
前个值表示-buffers/cache——应用程序使用的内存大小，used减去缓存值<br />
后个值表示+buffers/cache——所有可供应用程序使用的内存大小，free加上缓存值<br />
note:<br />
-buffers/cache=used-buffers-cached<br />
+buffers/cache=free+buffers+cached<br />
</p>

<p>
第三行表示swap的使用：<br />
used——已使用<br />
free——未使用<br />
</p>

<p>
cache释放：<br />
To free pagecache:<br />
echo 1 &gt; /proc/sys/vm/drop_caches<br />
To free dentries and inodes:<br />
echo 2 &gt; /proc/sys/vm/drop_caches<br />
To free pagecache, dentries and inodes:<br />
echo 3 &gt; /proc/sys/vm/drop_caches<br />
</p>

<p>
说明，释放前最好sync一下，防止丢数据。<br />
</p>
</div>
</div>

<div id="outline-container-org7a651dd" class="outline-2">
<h2 id="org7a651dd">使某一目录下创建的所有文件目录的groupname 都是 当前用户所属的组</h2>
<div class="outline-text-2" id="text-org7a651dd">
<div class="org-src-container">
<pre class="src src-sh">chmod g+s dir1
</pre>
</div>
<p>
dir1以下的FILE和FOLDER组名都是当前用户所属的组<br />
</p>
</div>
</div>
<div id="outline-container-orgaf3cae6" class="outline-2">
<h2 id="orgaf3cae6">umask</h2>
<div class="outline-text-2" id="text-orgaf3cae6">
<p>
umask就是指定“当前用户在建立文件或目录时候的属性默认值”<br />
对于文件来说，这一数字的最大值分别是6。<br />
目录则允许设置执行权限，这样针对目录来说，umask中各个数字最大可以到7。<br />
我们只要记住u m a s k是从权限中“拿走”相应的位即可。<br />
如：umask值为022，则默认目录权限为755，默认文件权限为644。<br />
对于组权限，setfacl设置的权限只对主组（即useradd -g或usermod -g的组）<br />
有效，对附加组（即useradd -G或usermod -aG的组）无效，即使文件的所有组已改为附加组。<br />
</p>
</div>
</div>
<div id="outline-container-orga64a61a" class="outline-2">
<h2 id="orga64a61a">setfacl</h2>
<div class="outline-text-2" id="text-orga64a61a">
<p>
/etc/fstab 里加 acl 选项<br />
</p>
<blockquote>
<p>
/dev/sda2		/		ext3		noatime,acl		0 1<br />
</p>
</blockquote>
<p>
mount -o remount /<br />
</p>
<div class="org-src-container">
<pre class="src src-sh">&#32473;&#26576;&#20010;&#29992;&#25143;&#35774;&#32622;&#26435;&#38480;&#65306;
setfacl -m u:joe:rx bobdir/
&#32473;&#26576;&#20010;&#32452;&#35774;&#32622;&#26435;&#38480;&#65306;
setfacl -m g:aclgp1:rx bobdir/
&#21462;&#28040;&#26576;&#39033;&#26435;&#38480;
setfacl -x g:aclgp1 bobdir/
</pre>
</div>
<div class="org-src-container">
<pre class="src src-sh">setfacl&#21629;&#20196;&#21487;&#20197;&#35782;&#21035;&#20197;&#19979;&#30340;&#35268;&#21017;&#26684;&#24335;&#12290;

[d[efault]:] [u[ser]:]uid [:perms]
&#25351;&#23450;&#29992;&#25143;&#30340;&#26435;&#38480;&#65292;&#25991;&#20214;&#25152;&#26377;&#32773;&#30340;&#26435;&#38480;&#65288;&#22914;&#26524;uid&#27809;&#26377;&#25351;&#23450;&#65289;&#12290;

[d[efault]:] g[roup]:gid [:perms]
&#25351;&#23450;&#32676;&#32452;&#30340;&#26435;&#38480;&#65292;&#25991;&#20214;&#25152;&#26377;&#32676;&#32452;&#30340;&#26435;&#38480;&#65288;&#22914;&#26524;gid&#26410;&#25351;&#23450;&#65289;

[d[efault]:] m[ask][:] [:perms]
&#26377;&#25928;&#26435;&#38480;&#25513;&#30721;

[d[efault]:] o[ther] [:perms]
</pre>
</div>
<div class="org-src-container">
<pre class="src src-sh">setfacl -m d:g:groupA:rwx /path/to/perms

The -m flag stands for <span style="color: #ffa07a;">"Modify"</span> the existing ACL. The little d<span style="color: #FBDE2D;"> in</span> front of g
makes it a <span style="color: #ffa07a;">"Default"</span> ACL, so that<span style="color: #FBDE2D;"> in</span> future if any file/dir gets created under
perms directory, groupA will have rwx permission on them too.
</pre>
</div>
</div>
</div>
<div id="outline-container-org3293365" class="outline-2">
<h2 id="org3293365">mbr and dd</h2>
<div class="outline-text-2" id="text-org3293365">
<p>
MBR=主引导区记录。硬盘的0磁道的第一个扇区称为MBR，它的大小是512字节，而这个区域<br />
可以分为三个部分。第一部分为pre-boot区（预启动区），占446字节；第二部分是<br />
Partition table区（分区表），占64个字节，硬盘中分区有多少以及每一分区的大小都记<br />
在其中。第三部分是magic number，占2个字节，固定为55AA。MBR是针对整个硬盘而言的，<br />
而引导扇区是对单个分区而言的。每个分区的第一扇区就是引导扇区：像MBR一样，引导扇<br />
区里包含了一些引导操作系统所需要的相关信息。如果引导扇区被破坏了是个非常严重的<br />
问题，那就意味着这个分区不能被访问，安装在这个分区上的操作系统也不能被启动。所<br />
以说修复引导是使得每一个分区都能被正确识别引导。<br />
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org4ebaa47">446+64+<span style="color: #40E0D0;">2</span>=512
dd &lt;/dev/sda <span style="color: #40E0D0;">bs</span>=512 <span style="color: #40E0D0;">count</span>=1 &gt;mbr512.img
dd &lt;mbr512.img <span style="color: #40E0D0;">bs</span>=446 <span style="color: #40E0D0;">count</span>=1 &gt;/dev/sda
dd &lt;mbr512.img <span style="color: #40E0D0;">bs</span>=1 <span style="color: #40E0D0;">count</span>=64 <span style="color: #40E0D0;">skip</span>=446 <span style="color: #40E0D0;">seek</span>=446 &gt;/dev/sda
</pre>
</div>
</div>
</div>
<div id="outline-container-org8d65187" class="outline-2">
<h2 id="org8d65187">ctags</h2>
<div class="outline-text-2" id="text-org8d65187">
<p>
<a href="http://blog.csdn.net/moiyer/article/details/5438962">http://blog.csdn.net/moiyer/article/details/5438962</a><br />
</p>
</div>
</div>
<div id="outline-container-org83b65d2" class="outline-2">
<h2 id="org83b65d2">nmap</h2>
<div class="outline-text-2" id="text-org83b65d2">
</div>
<ul class="org-ul">
<li><a id="org07b3015"></a>IP<br />
<div class="outline-text-4" id="text-org07b3015">
<p>
ip 地址范围 192.168.1.0/24<br />
192.168.1.1-254<br />
</p>
</div>
</li>
<li><a id="orgcce61da"></a>Port<br />
<div class="outline-text-4" id="text-orgcce61da">
<p>
指定端口 : -p80 -p1-1024<br />
</p>
</div>
</li>

<li><a id="org08d45e2"></a>-s 开头的 表示扫描<br />
<div class="outline-text-4" id="text-org08d45e2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">-sT</td>
<td class="org-left">扫描Tcp连接</td>
</tr>

<tr>
<td class="org-left">-sU</td>
<td class="org-left">扫描Udp连接</td>
</tr>

<tr>
<td class="org-left">-sP</td>
<td class="org-left">Ping扫描</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
<p>
扫描tcp连接<br />
nmap -sT 192.168.1.101<br />
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-org68a7b58" class="outline-2">
<h2 id="org68a7b58">tcpdump</h2>
<div class="outline-text-2" id="text-org68a7b58">
<p>
sudo tcpdump port 80 # only 80 端口<br />
sudo tcpdump -w filename port 80   # write to filename似乎 -w 参数不能太靠后<br />
</p>
</div>
</div>
<div id="outline-container-org73055af" class="outline-2">
<h2 id="org73055af">mac shutdown</h2>
<div class="outline-text-2" id="text-org73055af">
<p>
. 10分钟后关机 sudo shutdown -h +10<br />
. 晚上8点关机 sudo shutdown -h 20:00<br />
</p>
</div>
</div>


<div id="outline-container-orge2e2317" class="outline-2">
<h2 id="orge2e2317">linux下分辨率调整</h2>
<div class="outline-text-2" id="text-orge2e2317">
<p>
<a href="http://blog.csdn.net/wangfaqiang/article/details/6289959">http://blog.csdn.net/wangfaqiang/article/details/6289959</a><br />
</p>
<div class="org-src-container">
<pre class="src src-sh">&#25105;&#30340;&#29702;&#35299;&#23601;&#26159;&#65292;&#38271;1440 &#23485;900,&#28145;75
root@jf /home/jixiuf <span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">cvt 1440 900 75</span>
&#29983;&#25104; Modeline&#36825;&#19968;&#34892;
<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">1440x900 74.98 Hz (CVT 1.30MA) hsync: 70.64 kHz; pclk: 136.75 MHz</span>
Modeline <span style="color: #ffa07a;">"1440x900_75.00"</span>  136.75  1440 1536 1688 1936  900 903 909 942 -hsync +vsync
</pre>
</div>
<p>
然后，配成这面的样子，即可<br />
</p>
<blockquote>
<p>
Section "Monitor"<br />
Identifier      "Configured Monitor"<br />
Modeline "1440x900_75.00"  136.75  1440 1536 1688 1936  900 903 909 942 -hsync +vsync<br />
Option          "PreferredMode" "1440x900_75.00"<br />
EndSection<br />
</p>

<p>
Section "Screen"<br />
Identifier      "Default Screen"<br />
Monitor         "Configured Monitor"<br />
Device          "Configured Video Device"<br />
EndSection<br />
</p>

<p>
Section "Device"<br />
Identifier "Configured Video Device"<br />
EndSection<br />
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org84c35d8" class="outline-2">
<h2 id="org84c35d8">通过ssh 连接远程机器上的mysql 等</h2>
<div class="outline-text-2" id="text-org84c35d8">
<p>
通常的情况是远程 42.62.14.55 上有一个mysql ,兼听在3306端口上<br />
但是防火墙阻止直接连3306端口<br />
解决加法是 ssh 连上42.62.14.55 ,然后在ssh 访问mysql 3306端口，<br />
此时防问<br />
ssh -L 3307:localhost:3306 username@42.62.14.55 -N<br />
</p>

<p>
这个时候在你的本机会开一个3307端口<br />
然后 mysql -uroot -ppass -P3307 就可以连上这个mysql了<br />
</p>
</div>
</div>
<div id="outline-container-org8a8a690" class="outline-2">
<h2 id="org8a8a690">iptables 作端口转发</h2>
<div class="outline-text-2" id="text-org8a8a690">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #AEAEAE;">#</span><span style="color: #AEAEAE;">!/bin/</span><span style="color: #FBDE2D;">sh</span>
    <span style="color: #40E0D0;">pro</span>=<span style="color: #ffa07a;">'tcp'</span>
    <span style="color: #40E0D0;">NAT_Host</span>=<span style="color: #ffa07a;">'101.200.145.250'</span>
    <span style="color: #40E0D0;">NAT_Port</span>=3005
    <span style="color: #40E0D0;">Dst_Host</span>=<span style="color: #ffa07a;">'101.200.145.250'</span>
    <span style="color: #40E0D0;">Dst_Port</span>=9001
    iptables -t nat -A PREROUTING  -m $<span style="color: #40E0D0;">pro</span> -p $<span style="color: #40E0D0;">pro</span> --dport $<span style="color: #40E0D0;">NAT_Port</span> -j DNAT --to-destination $<span style="color: #40E0D0;">Dst_Host</span>:$<span style="color: #40E0D0;">Dst_Port</span>
    iptables -t nat -A POSTROUTING -m $<span style="color: #40E0D0;">pro</span> -p $<span style="color: #40E0D0;">pro</span> --dport $<span style="color: #40E0D0;">Dst_Port</span> -d $<span style="color: #40E0D0;">Dst_Host</span> -j SNAT --to-source $<span style="color: #40E0D0;">NAT_Host</span>
</pre>
</div>
<p>
   以上脚本 当访问 NAT_Host:NAT_Port 时，请求会被转发到 Dst_Host:Dst_Port 端口<br />
若不管用<br />
sudo service iptables save 后<br />
有可能需要把 /etc/sysconfig/iptables 内下面两行注释掉 重启iptables<br />
</p>
<blockquote>
<p>
#-A INPUT -j REJECT &#x2013;reject-with icmp-host-prohibited         //这两行最好是注释掉。在一般的白名单设置中，如果这两行不注释，也会造成iptables对端口的设置无效<br />
#-A FORWARD -j REJECT &#x2013;reject-with icmp-host-prohibited<br />
</p>
</blockquote>
<div class="org-src-container">
<pre class="src src-sh">iptables -L -n -a nat

</pre>
</div>
</div>
</div>

<div id="outline-container-org92d5efb" class="outline-2">
<h2 id="org92d5efb">ssh socat</h2>
<div class="outline-text-2" id="text-org92d5efb">
<p>
我局域网ip 是192.168.1网段的<br />
</p>

<p>
10.142.8.24 是位于另一网段的一台内网机器　,<br />
122.224.249.55 是一台有公网ip的机器，<br />
10.142.8.24位于122.224.249.55后面<br />
也就是说要想ssh连接到10.142.8.24需要途经 122.224.249.55<br />
用到了socat这款软件做代理<br />
使用如下命令,<br />
本机ip: 192.168.1.127<br />
</p>

<p>
防火墙 122.224.249.55 port 9991<br />
内网机　10.142.8.24 ssh 端口开在36000上<br />
</p>

<p>
sudo ssh -o ProxyCommand='socat - socks:122.224.249.55:%h:%p,socksport=9991' username@10.142.8.24 -p 36000<br />
没加 sudo 之前一直给我提示Permission denied (keyboard-interactive),不知原因何<br />
在，难道socat命令需要root权限<br />
</p>
</div>
</div>
<div id="outline-container-orge382e71" class="outline-2">
<h2 id="orge382e71">ssh tunnel</h2>
<div class="outline-text-2" id="text-orge382e71">
<p>
socks5 7070端口<br />
ssh -p 2222  -D 0.0.0.0:7070 deployer@se.najaplus.com -N -4<br />
ssh -p 2222  -D 7070 deployer@se.najaplus.com -N -4<br />
-4 ipv4<br />
</p>

<p>
ssh -L 3307:serverip:3306 root@serverip -N<br />
则直接访问本机3307端口 相当于方法serverip的3306端口<br />
</p>
</div>
<div id="outline-container-orgd04f7c9" class="outline-3">
<h3 id="orgd04f7c9">ssh 反向tunnel 实现借助外网机访问内网机服务器</h3>
<div class="outline-text-3" id="text-orgd04f7c9">
<p>
参考 <a href="https://my.oschina.net/abcfy2/blog/177094">https://my.oschina.net/abcfy2/blog/177094</a><br />
</p>
<ol class="org-ol">
<li><p>
在内网机上运行以下命令，则访问dev.najaplus.com 的3009端口相当于访问 内网机的22端口<br />
</p>
<div class="org-src-container">
<pre class="src src-sh">autossh -M 5678 -NR 3009:localhost:22 deployer@dev.najaplus.com
    <span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">&#19981;&#22826;&#29702;&#29702;5678&#31471;&#21475;&#30340;&#20316;&#29992;</span>
</pre>
</div></li>
<li><p>
在外网机上运行以下命令<br />
</p>
<div class="org-src-container">
<pre class="src src-sh">    &#23454;&#38469;&#19978;&#30331;&#24405;&#21040;&#20869;&#32593;&#30456;&#30340;22&#31471;&#21475;&#65292;&#21363;&#30331;&#24405;&#20869;&#32593;&#26426;&#30340;ssh,(&#20869;&#32593;&#26426;&#38656;&#35201;&#21551;&#21160;sshd)
ssh -p 3009 jixiuf@localhost
</pre>
</div>
<p>
另外在外网机上可以看到3009牌listen状态，且绑定在127.0.0.1,也就是说只能从本机对3009进行访问<br />
<img src="/assets/blog/linux.html/linux-2017-05-24-22-50-37.png" alt="linux-2017-05-24-22-50-37.png" /><br />
</p></li>
</ol>

<p>
同相的道理，假如内网机80端口有web服务<br />
    autossh -M 5679 -NR 3008:localhost:80 deployer@dev.najaplus.com<br />
    则在外网访问外网的3008端口 相当于访问内网机的80端口<br />
    结合nginx 代理3008端口即在任意地址访问外网的80端口来实现访问内网的服务<br />
</p>
</div>
</div>
</div>

<div id="outline-container-org884cce9" class="outline-2">
<h2 id="org884cce9">tsocks 配置</h2>
<div class="outline-text-2" id="text-org884cce9">
<p>
wget ,git  通过ssh tunnel 连网<br />
tsocks wget <a href="http://googletest.googlecode.com/files/gtest-1.5.0.tar.bz2">http://googletest.googlecode.com/files/gtest-1.5.0.tar.bz2</a><br />
tsocks git clone url<br />
tsocks curl url<br />
tsocks go get google.golang.org/grpc<br />
tsocks 的安装<br />
brew tap Anakros/homebrew-tsocks<br />
brew install &#x2013;HEAD tsocks<br />
vim /usr/local/etc/tsocks.conf<br />
     server = 127.0.0.1<br />
     server_type = 5    #to use socks V5<br />
     server_port = 7070  #the port of your porxy%<br />
 类似工具<br />
 brew install proxychains-ng<br />
 /usr/local/etc/proxychains.conf<br />
    socks5 	127.0.0.1 7070<br />
</p>
</div>
</div>
<div id="outline-container-orgee69b2f" class="outline-2">
<h2 id="orgee69b2f">adb shell</h2>
<div class="outline-text-2" id="text-orgee69b2f">
<p>
su<br />
 mount -o remount,rw /  /<br />
  mount -o remount,rw /system<br />
 FAQ：提示没有权限如何处理？<br />
 cannot create hosts: read-only file system<br />
 出现以上红色问题，需要执行以下命令<br />
</p>

<p>
adb kill-server 停止服务器<br />
adb remount  重新挂载文件系统<br />
adb reboot 重启手机<br />
adb logcat 查看手机上的运行日志，此项可以用来查错<br />
</p>
</div>
</div>
<div id="outline-container-org796cb91" class="outline-2">
<h2 id="org796cb91">curl demo</h2>
<div class="outline-text-2" id="text-org796cb91">
<p>
curl <a href="https://api.sandbox.paypal.com/v1/oauth2/token">https://api.sandbox.paypal.com/v1/oauth2/token</a> -H "Accept: application/json"<br />
-H "Accept-Language: en_US"<br />
-u "AVNJj1L75UxFsQYwqBRk8s_5qc07ARsy-vznUCpnxLaP2pGqwzUXLFqaWANhBZjhGsrG83Ad7Xwtni1P:EBUuK3Gr7e5JFe7SxNAtvkas2NEvwoKwp-_UCMQwNymCCDHlJJ6OCtBwvWyDH03XXPfZgn49vcnBmHrC"<br />
-d "grant_type=client_credentials"<br />
-L follow redirect<br />
</p>
</div>
</div>
<div id="outline-container-org92f7748" class="outline-2">
<h2 id="org92f7748">time sync</h2>
<div class="outline-text-2" id="text-org92f7748">
<div class="org-src-container">
<pre class="src src-sh">cat /etc/ntp.conf|grep server&#20250;&#21015;&#20986;&#20960;&#20010;&#26381;&#21153;&#22120;
</pre>
</div>
<p>
没有的话会<a href="http://www.pool.ntp.org/zone/cn%E6%89%BE%E7%A6%BB%E8%87%AA%E5%B7%B1%E6%9C%80%E8%BF%91%E7%9A%84server">http://www.pool.ntp.org/zone/cn%E6%89%BE%E7%A6%BB%E8%87%AA%E5%B7%B1%E6%9C%80%E8%BF%91%E7%9A%84server</a>, 如<br />
</p>
<blockquote>
<p>
server 0.asia.pool.ntp.org<br />
    server 1.asia.pool.ntp.org<br />
    server 2.asia.pool.ntp.org<br />
    server 3.asia.pool.ntp.org<br />
</p>
</blockquote>
<div class="org-src-container">
<pre class="src src-sh">sudo yum install ntp
&#25163;&#21160;&#21516;&#27493;&#20004;&#27425;
sudo ntpdate -u 0.asia.pool.ntp.org
sudo ntpdate -u 0.asia.pool.ntp.org

sudo service ntpd start
sudo chkconfig ntpd on
<span style="color: #AEAEAE;">#</span><span style="color: #AEAEAE;">&#26597;&#30475;&#21516;&#27493;&#24773;&#20917;</span>
watch ntpq -p
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd52bbcc" class="outline-2">
<h2 id="orgd52bbcc">sed 一些用法</h2>
<div class="outline-text-2" id="text-orgd52bbcc">
<ol class="org-ol">
<li>最常见的 sed 's/old/new/g' filename<br /></li>

<li><p>
如果想直接修改原文件<br />
</p>
<div class="org-src-container">
<pre class="src src-sh">sed  -i <span style="color: #ffa07a;">""</span> <span style="color: #ffa07a;">'s/2/3/g'</span> a.txt
<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">&#25110;&#20094;&#20462;&#25913;&#21069;&#23558;&#21407;&#25991;&#20214;&#22791;&#20221;&#20026; a.txt.bak</span>
sed  -i <span style="color: #ffa07a;">".bak"</span> <span style="color: #ffa07a;">'s/2/3/g'</span> a.txt
</pre>
</div></li>

<li><p>
提取匹配的某一部分 (这里最后用到了/p  估计是print 的意思)<br />
比如文件有有一行内容如下,我想取出其中的数字部分<br />
    AC_PREREQ(2.65)<br />
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #40E0D0;">autoconf_min</span>=<span style="font-weight: bold;">`sed -n 's/^ *AC_PREREQ(\([0-9\.]*\)).*/\1/p' configure.ac`</span>
<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">&#20854;&#20013; \1  &#24341;&#29992; \([0-9\.]*\) &#21305;&#37197;&#30340;&#37096;&#20998;</span>
</pre>
</div>
<p>
常用到从某文件中取版本号等<br />
</p></li>

<li><p>
有条件的替换<br />
</p>
<div class="org-src-container">
<pre class="src src-sh">sed -i <span style="color: #ffa07a;">'/SELINUX/s/enforcing/disabled/'</span> /etc/selinux/config
</pre>
</div>
<p>
实现将 如果某行含有SELINUX 这个关键字，则把此行的 enforcing 替换成 disabled<br />
实际实现了 将SELINUX=enforcing 换成SELINUX=disabled 这个功能<br />
</p></li>
</ol>
</div>
</div>
<div id="outline-container-orgbe55eb3" class="outline-2">
<h2 id="orgbe55eb3">grep</h2>
<div class="outline-text-2" id="text-orgbe55eb3">
</div>
<div id="outline-container-org1f0a472" class="outline-3">
<h3 id="org1f0a472">grep -v 过滤 不匹配的行</h3>
</div>
<div id="outline-container-org30735a4" class="outline-3">
<h3 id="org30735a4">grep -P 以perl正则来匹配(linux支持,mac不支持)</h3>
<div class="outline-text-3" id="text-org30735a4">
<p>
过滤@的行, 但是不过滤@case的行<br />
</p>
<div class="org-src-container">
<pre class="src src-sh">grep -P <span style="color: #ffa07a;">"@(?!case)"</span> <span style="color: #AEAEAE;">#</span><span style="color: #AEAEAE;">&#29992;&#21040;&#20102;&#38646;&#23485;&#26029;&#35328; (&#21363;@&#21518;&#19981;&#20026;case&#30340;)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfa76ac5" class="outline-3">
<h3 id="orgfa76ac5">grep [a,A]..[b,B]* file  在文件中查找a（或A）开头，第四个字母为b（或B）的所有单词</h3>
</div>
<div id="outline-container-orgfbe1d60" class="outline-3">
<h3 id="orgfbe1d60">grep -E 'string1|string2' file        搜寻文件中或者存在string1或者存在string2的行</h3>
</div>
<div id="outline-container-org6ffa681" class="outline-3">
<h3 id="org6ffa681">利用grep -c 来作instr()用</h3>
<div class="outline-text-3" id="text-org6ffa681">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #AEAEAE;">#</span><span style="color: #AEAEAE;">!/bin/</span><span style="color: #FBDE2D;">sh</span>
<span style="color: #40E0D0;">a</span>=<span style="color: #ffa07a;">"Hello i am pass"</span>;
<span style="color: #FBDE2D;">if</span> [ <span style="font-weight: bold;">`echo $a | grep -c "pass" `</span> -gt 0 ]
<span style="color: #FBDE2D;">then</span>
  <span style="color: #F8F8F8;">echo</span> <span style="color: #ffa07a;">"Success"</span>
<span style="color: #FBDE2D;">else</span>
  <span style="color: #F8F8F8;">echo</span> <span style="color: #ffa07a;">"Fail"</span>;
<span style="color: #FBDE2D;">fi</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org0943c6e" class="outline-2">
<h2 id="org0943c6e">find</h2>
<div class="outline-text-2" id="text-org0943c6e">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">&#20462;&#25913;&#26102;&#38388;&#22312;10&#22825;&#21069;&#30340;&#37117;&#21024;&#38500;</span>
find . -maxdepth 1 -mtime +10 -exec rm  -rf {} <span style="color: #ffa07a;">\;</span>
<span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">&#20462;&#25913;&#26102;&#38388;&#22312;10&#22825;&#20043;&#20869;&#30340;&#37117;&#21024;&#38500;</span>
find . -maxdepth 1 -mtime -10 -exec rm  -rf {} <span style="color: #ffa07a;">\;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orged9d63a" class="outline-2">
<h2 id="orged9d63a">“.”点号替代单个字符</h2>
<div class="outline-text-2" id="text-orged9d63a">
<p>
这个用法真的非常非常有用，极力推荐。<br />
grep [a,A]..[b,B]* file  在文件中查找a（或A）开头，第四个字母为b（或B）的所有单词<br />
sed 's/^&#x2026;.//g' file        删除文件所有行的前4列<br />
sed 's/^&#x2026;..//g' file        删除文件所有行的前5列<br />
</p>
</div>
</div>

<div id="outline-container-org3622f5a" class="outline-2">
<h2 id="org3622f5a">shell for if example</h2>
<div class="outline-text-2" id="text-org3622f5a">
<div class="org-src-container">
<pre class="src src-sh" id="org932071b">  <span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">&#36807;&#28388;&#25481;&#24320;&#22836;&#26159;#&#30340;&#27880;&#37322;&#34892;</span>
<span style="color: #FBDE2D;">for</span> url<span style="color: #FBDE2D;"> in</span>  <span style="font-weight: bold;">`cat $MODULE_FILE_NAME|grep -v "^[ \t]*#" `</span> ; <span style="color: #FBDE2D;">do</span>
    <span style="color: #40E0D0;">mod</span>=<span style="font-weight: bold;">`echo $url|sed 's|.*/||g'|awk -F '.git$' '{print $1}'`</span>
    <span style="color: #40E0D0;">abs_mod_path</span>=$<span style="color: #40E0D0;">WORD_DIR</span>/$<span style="color: #40E0D0;">mod</span>
    <span style="color: #FBDE2D;">if</span> [ -d $<span style="color: #40E0D0;">abs_mod_path</span> ] &amp;&amp; [ -d $<span style="color: #40E0D0;">abs_mod_path</span>/.git ] ; <span style="color: #FBDE2D;">then</span>
        <span style="color: #AEAEAE;"># </span><span style="color: #AEAEAE;">&#22914;&#26524;&#24211;&#24050;&#32463;&#23384;&#22312;</span>
        <span style="color: #F8F8F8;">echo</span> $<span style="color: #40E0D0;">abs_mod_path</span>
        <span style="color: #F8F8F8;">cd</span> $<span style="color: #40E0D0;">abs_mod_path</span>
        git checkout master
        git pull
    <span style="color: #FBDE2D;">else</span>
        <span style="color: #F8F8F8;">cd</span> $<span style="color: #40E0D0;">WORD_DIR</span>
        git clone $<span style="color: #40E0D0;">url</span>
    <span style="color: #FBDE2D;">fi</span>
<span style="color: #FBDE2D;">done</span>
</pre>
</div>
</div>
</div>





<div id="outline-container-org172e61b" class="outline-2">
<h2 id="org172e61b">用python 格式化json</h2>
<div class="outline-text-2" id="text-org172e61b">
<p>
cat a.json|python -m json.tool<br />
</p>
</div>
</div>

<div id="outline-container-org40e85a7" class="outline-2">
<h2 id="org40e85a7">awk 怎么去除如果第一列相同，则只取一行？</h2>
<div class="outline-text-2" id="text-org40e85a7">
<blockquote>
<p>
例如：<br />
aaaaaa,bbbbbb,ccccccc<br />
sssssss,fffffffffff,wwwww<br />
eeeeee,rrrrrrrrr,2222222<br />
aaaaaa,qqqqqq,wwwwww<br />
sssssss,wwwww,3333333<br />
&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;<br />
&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;<br />
&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.<br />
&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.<br />
eeeeeee,tttttttttt,44444444<br />
</p>


<p>
以逗号分隔，就是如果第一列是重复的，不管后边的列，只取一行，怎么取<br />
</p>
</blockquote>
<div class="org-src-container">
<pre class="src src-sh">awk -F, <span style="color: #ffa07a;">'!a[$1]++'</span> urfile
</pre>
</div>
<blockquote>
<p>
! a[$1] ++<br />
0为假， !0 为真<br />
以第一列（逗号分隔）为索引的数组元素的值为0则输出，输出后数组元素值++， 后面的行$1相同时a[$1]的值就不为0了。<br />
</p>
</blockquote>
</div>
</div>
<div id="outline-container-orgfa0edc8" class="outline-2">
<h2 id="orgfa0edc8">awk 替换</h2>
<div class="outline-text-2" id="text-orgfa0edc8">
<div class="org-src-container">
<pre class="src src-sh">awk <span style="color: #ffa07a;">'{sub(/6.5.4/,"6.5.7");print}'</span> globalrc
awk <span style="color: #ffa07a;">'{sub(/package design/,"package cavedesign");print &gt;"db_defs_design_select.go"}'</span> ./data/output/db_defs_design_select.go
</pre>
</div>
</div>
</div>
<div id="outline-container-orgeb656d0" class="outline-2">
<h2 id="orgeb656d0">awk 在指定的行添加内容添加行</h2>
<div class="outline-text-2" id="text-orgeb656d0">
<div class="org-src-container">
<pre class="src src-sh">awk -v <span style="color: #ffa07a;">"n=line-number"</span><span style="color: #ffa07a;">\</span>
 -v <span style="color: #ffa07a;">'line1=import "github.com/gogo/protobuf/gogoproto/gogo.proto"; '</span><span style="color: #ffa07a;">\</span>
 -v <span style="color: #ffa07a;">'line2=option (gogoproto.marshaler_all) = true;'</span><span style="color: #ffa07a;">\</span>
 -v <span style="color: #ffa07a;">'line3=option (gogoproto.sizer_all) = true;'</span><span style="color: #ffa07a;">\</span>
 -v <span style="color: #ffa07a;">'line4=option (gogoproto.unmarshaler_all) = true;'</span><span style="color: #ffa07a;">\</span>
 <span style="color: #ffa07a;">'(NR==2) { print line1;print line2;print line3;print line4 } 1;'</span>  pf.proto
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd7c2b8b" class="outline-2">
<h2 id="orgd7c2b8b">压测用工具</h2>
<div class="outline-text-2" id="text-orgd7c2b8b">
</div>
<div id="outline-container-orgbc5e43c" class="outline-3">
<h3 id="orgbc5e43c">ab -n 1000000 -c 1000 -p /tmp/a -T application/json  -H "X-UID: 1000000013" <a href="http://diary.dev.igetget.com/diary/v1/data/list">http://diary.dev.igetget.com/diary/v1/data/list</a></h3>
<div class="outline-text-3" id="text-orgbc5e43c">
<p>
-n 总请求数<br />
-c 并发数<br />
 其中/tmp/a 为post 的内容<br />
</p>
</div>
</div>
<div id="outline-container-org90a9263" class="outline-3">
<h3 id="org90a9263">siege -c 1000  -b -q -r 1000000   -H "X-Uid: 1000100366" -H "X-Av: 3.0.9" -H "X-D: aaa" -f choicesnow.txt</h3>
<div class="outline-text-3" id="text-org90a9263">
<p>
-c 并发<br />
-r  repetition 次数，重复次数<br />
-b  表示benchmark<br />
-q quiet<br />
-f 后是文件， 里面内容每行表示一个http的请求，形如<br />
   baidu.com POST column_id=1&amp;id=2<br />
   google.com POST column_id=1&amp;id=2<br />
</p>
</div>
</div>
</div>
<div id="outline-container-orgcdf7735" class="outline-2">
<h2 id="orgcdf7735">ab http压测</h2>
<div class="outline-text-2" id="text-orgcdf7735">
<p>
  ab -c 100 -n 100 <a href="http://url">http://url</a> 并发100 ，共1000个请求<br />
一个请求 响应时间20ms左右为佳，随着并发量会略有增加 但100ms是个阀值<br />
超过100ms 虽然也可能正常，但该考虑优化， 比如加缓存等<br />
   <img src="/assets/blog/linux.html/linux-2017-09-21-21-26-38.png" alt="linux-2017-09-21-21-26-38.png" /><br />
</p>
</div>
</div>
<div id="outline-container-org68135a3" class="outline-2">
<h2 id="org68135a3">tcpcopy 线上数据导入测度服进行压测</h2>
<div class="outline-text-2" id="text-org68135a3">
<p>
<a href="http://blog.gaoyuan.xyz/2014/01/08/use-tcpcopy-test-online/">http://blog.gaoyuan.xyz/2014/01/08/use-tcpcopy-test-online/</a><br />
</p>
</div>
</div>
<div id="outline-container-org3423fe4" class="outline-2">
<h2 id="org3423fe4">使用charles在移动设备上捕获https数据包</h2>
<div class="outline-text-2" id="text-org3423fe4">
<p>
主要利用中间人欺骗来实现<br />
</p>
</div>
</div>
<div id="outline-container-org803ce54" class="outline-2">
<h2 id="org803ce54">如何应对三高</h2>
<div class="outline-text-2" id="text-org803ce54">
</div>
<div id="outline-container-orgc9e1764" class="outline-3">
<h3 id="orgc9e1764">高并发</h3>
<div class="outline-text-3" id="text-orgc9e1764">
</div>
<ul class="org-ul">
<li><a id="org83b9876"></a>无状态<br /></li>
<li><a id="org05f70f2"></a>并行化 (串行请求改进，多个子系统的并行化waitgroup)<br /></li>
<li><a id="orged09993"></a>数据异构 (关系型不合适的可用,使用key value )<br /></li>
<li><a id="org62980ee"></a>消息队列<br /></li>
</ul>
</div>

<div id="outline-container-orgd67eccd" class="outline-3">
<h3 id="orgd67eccd">高可用</h3>
<div class="outline-text-3" id="text-orgd67eccd">
<p>
隔离 降级<br />
</p>

<p>
低延迟<br />
静态化<br />
缓存<br />
性能优化 (硬件\os\)<br />
扩展性<br />
</p>

<p>
隔离<br />
线程进程隔离 (不同业务逻辑 使用不同优先级的线程池等，各业务不会相互影响)<br />
读写分离(db,queue写消峰)<br />
动静数据分开(一张表 多变与不变者分)<br />
热点隔离 冷热数据分开<br />
资源隔离(根据业务物理上拆库拆缓存)<br />
</p>

<p>
限流(基本都是拿到令牌的才允许进一步访问，没拿到令牌的，前端就挡回,拿到的后端服务要验证令牌)比如小米限量抢购<br />
要前端分配令牌的  可以做成无状态的，可以无限水平扩展，<br />
令牌桶算法<br />
漏桶算法<br />
</p>

<p>
应用层限流<br />
    限流总并发，连接，请求<br />
    限流资源数<br />
    限流时间窗口内请求数<br />
	是否需要平滑(1秒一个， 还是1min60个)<br />
    分布式限流<br />
</p>

<p>
接入层限流<br />
</p>

<p>
nginx +lua<br />
	ngx_http_limit_conn_modules限制并发连接数 (配置)<br />
	ngx_http_limit_req_modeles (配置)<br />
	openresty lua-resty-limit-traffic<br />
apigateway<br />
</p>

<p>
降级预案<br />
主动降级(业务相关 开关进行控制) 被动降级<br />
降级开关<br />
读降级 写降级(异地多活,数据中心出问题，不允许写，但是可读) 如数据库<br />
</p>
</div>
</div>
</div>

<div id="outline-container-orga77c5df" class="outline-2">
<h2 id="orga77c5df">ssh 避免输入密码的办法</h2>
<div class="outline-text-2" id="text-orga77c5df">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #AEAEAE;">#</span><span style="color: #AEAEAE;">!/usr/bin/</span><span style="color: #FBDE2D;">expect</span>
spawn ssh hello@ip
expect <span style="color: #ffa07a;">"*password:"</span>
send <span style="color: #ffa07a;">"yourpasswordhere"</span>
expect <span style="color: #ffa07a;">"*#"</span>
interact

</pre>
</div>
</div>
</div>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2013-02-17</span>
        <span title="last modification date" class="post-info">2021-09-10</span>
        <span title="tags" class="post-info"><a href="/tags/linux/">Linux</a></span>
        <span title="author" class="post-info">纪秀峰</span>
      </div>
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          //var disqus_developer = 1;
          var disqus_identifier = "/blog/linux.html";
          var disqus_url = "http://jixiuf.github.io/blog/linux.html";
          var disqus_shortname = 'jixiuf';
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <div class="ds-thread"></div>
        <script type="text/javascript">
          var duoshuoQuery = {short_name:'jixiuf'};
          (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = 'http://static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
          || document.getElementsByTagName('body')[0]).appendChild(ds);
          })();
        </script>
      </section>
      <script src="http://code.jquery.com/jquery-latest.min.js"></script>
      <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script> -->
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="/media/js/main.js"></script>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x (<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
          Copyright &copy; 2012 - <span id="footerYear"></span> <a href="mailto:jixiuf &lt;at&gt; gmail &lt;dot&gt; com">纪秀峰</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

  </body>
</html>
